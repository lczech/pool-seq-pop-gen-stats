\documentclass[a4paper,fontsize=9pt,DIV=14]{scrartcl}
% \documentclass[a4paper,10pt,DIV=14]{scrartcl}
% \documentclass[a4paper,10pt,DIV=13]{scrartcl} % scrreprt

\usepackage[utf8]{inputenc}
\setlength{\parskip}{0.8em}
\setlength{\parindent}{0pt}

% ######################################################################################################################
%         Custom Packages
% ######################################################################################################################

\usepackage{graphicx}
\usepackage[table]{xcolor}

\graphicspath{{figures/fst_plot_pdf/}}

\usepackage[square,sort,comma,numbers]{natbib}
\usepackage[english]{babel}
\usepackage[notlot,nottoc,numbib]{tocbibind}
\renewcommand{\bibsection}{\section{References}}
\AtBeginDocument{\def\bibname{References}}

% https://tex.stackexchange.com/questions/267675/pdftex-error-pdflatex-file-ecbx0800-font-ecbx0800-at-600-not-found
\usepackage{lmodern}

% https://reu.dimacs.rutgers.edu/Symbols.pdf
\usepackage{amssymb}

% https://tex.stackexchange.com/a/6105
% \usepackage[binary-units=true]{siunitx}
\usepackage{siunitx}

% https://tex.stackexchange.com/questions/94845/problems-with-toprule-and-midrule-in-a-table
\usepackage{booktabs}

% https://ctan.org/pkg/relsize
\usepackage{relsize}

\usepackage[bf,format=plain]{caption}

% https://tex.stackexchange.com/questions/135358/changing-the-formatting-of-subcaption-for-reference
\usepackage[labelformat=simple]{subcaption}
\renewcommand\thesubfigure{(\alph{subfigure})}

% https://tex.stackexchange.com/a/39981
\usepackage[nolist,nohyperlinks]{acronym}

% http://bytesizebio.net/2013/03/11/adding-supplementary-tables-and-figures-in-latex/
\newcommand{\beginsupplement}{%
    \setcounter{table}{0}
    \renewcommand{\thetable}{\arabic{table}}%
    \setcounter{figure}{0}
    \renewcommand{\thefigure}{\arabic{figure}}%
}
%     \renewcommand{\thetable}{S\arabic{table}}%
%     \renewcommand{\thefigure}{S\arabic{figure}}%

\usepackage{amsmath}
\usepackage{xfrac}
\usepackage{bm}
\usepackage{scalerel,stackengine}

% Increase row spacing in align envs
% https://tex.stackexchange.com/a/14680/171851
\addtolength{\jot}{0.75em}

% Excluded the following lines from the pnas class file.
% Include them here again to ensure correct setup.
% See https://tex.stackexchange.com/q/1863
\usepackage[colorlinks=true, allcolors=blue]{hyperref}
\renewcommand\UrlFont{\color{black}\sffamily}

% https://tex.stackexchange.com/a/78020
\pdfsuppresswarningpagegroup=1

% \externaldocument[main:]{main}

% \usepackage{nameref,zref-xr}
% \zxrsetup{toltxlabel}
% \zexternaldocument*{pppp}

% https://tex.stackexchange.com/questions/180019/grouping-two-tables-one-above-the-other
\usepackage{hypcap} % fix the links

% https://tex.stackexchange.com/questions/109467/footnote-in-tabular-environment
\usepackage{threeparttable}
% \usepackage[flushleft]{threeparttable}

% Sections with dots in TOC
% https://tex.stackexchange.com/a/53901/171851
\usepackage{tocloft}
\renewcommand{\cftsecleader}{\cftdotfill{\cftdotsep}}

% LEFT-ALIGN THE AUTHOR LIST
% Overleaf syntax highlighting gets messed up by this, but it works.
% Commented out now to not mess with overleaf for now.
% https://tex.stackexchange.com/a/364432/171851
% \usepackage{xpatch}
% \makeatletter
% \xpatchcmd{\@maketitle}{\begin{center}}{\begin{flushleft}}{}{}
% \xpatchcmd{\@maketitle}{\end{center}}{\end{flushleft}}{}{}
% \xpatchcmd{\@maketitle}{\begin{tabular}[t]{c}}{\begin{tabular}[t]{@{}l@{}}}{}{}
% \makeatother

% ######################################################################################################################
%         Custom Commands
% ######################################################################################################################

% Preparation for the todo command
\newcounter{todo}
\setcounter{todo}{0}
\newcounter{popoolissue}
\setcounter{popoolissue}{0}

% ----------------------------------------------------------
% TODO command:

% Use the first line below to show them,
% use the second to hide them,
% and comment out the respective other line.
% LaTeX is so easy ;-)

\newcommand\todo[1]{{\stepcounter{todo}\color{purple}{TODO \arabic{todo}: #1}}}
% \newcommand\todo[1]{}

% Same for "popoolissue", which we use to annotate our questions for the popoolation team
\newcommand\popoolissue[1]{{\stepcounter{popoolissue}\color{purple}{ITEM \arabic{popoolissue}: #1}}}
% \newcommand\popoolissue[1]{}
% ----------------------------------------------------------


% todo environment
% \newcounter{todo}
% \newcommand\todo[1]{\refstepcounter{todo}{\color{purple}{#1}}\addcontentsline{todolist}{subsection}{\thetodo:~#1}}
% un-comment the next line in order to hide all todos:
% \renewcommand\todo[1]{}
% \newcommand\moi[1]{{\color{orange}{#1}}}

% Suppress KOMA script warning
% https://tex.stackexchange.com/q/412368
\DeclareOldFontCommand{\bf}{\normalfont\bfseries}{\mathbf}

% https://nw360.blogspot.de/2007/12/rename-bibliography-title-in-latex.html
% https://tex.stackexchange.com/a/306268
% \renewcommand\refname{References}
% \renewcommand\bibname{References}
% \addto{\captionsenglish}{%
%   \renewcommand{\bibname}{References}
% }

% Define custom styles
\newcommand\toolname{\textsc}
\newcommand\taxonname{\textit}
\newcommand\formatname{\texttt}
\newcommand\langname{\texttt}

% \newcommand\figref[1]{Figure~\ref{#1}}
% \newcommand\tabref[1]{Table~\ref{#1}}
% \newcommand\eqnref[1]{Equation~(\ref{#1})}

\newcommand\figref[1]{Figure~\ref{#1}}
\newcommand\tabref[1]{Table~\ref{#1}}
\newcommand\eqnref[1]{Eq.~(\ref{#1})}
\newcommand\secref[1]{Section~\ref{#1}}

\newcommand{\samplesize}{n}
\newcommand{\coverage}{c}
\newcommand{\empfreq}{\widehat{f}}
\newcommand{\thetapi}{\widehat{\theta_\pi}}
\newcommand{\watterson}{\widehat{\theta_\text{W}}}
\newcommand{\fst}{F\textsubscript{ST}}
\newcommand{\mathfst}{F_\text{ST}}
\newcommand{\neifst}{F_\text{ST}^\text{Nei}}
\newcommand{\hudsonfst}{F_\text{ST}^\text{Hudson}}
\newcommand{\neiestimator}{\widehat{F}_\text{ST}^\text{Nei}}
\newcommand{\hudsonestimator}{\widehat{F}_\text{ST}^\text{Hudson}}
\newcommand{\eg}{e.\,g.,~}
\newcommand{\ie}{i.\,e.,~}

\newcommand\citeay[1]{\citeauthor{#1} (\citeyear{#1}) \cite{#1}}
\usepackage{cleveref}

% https://tex.stackexchange.com/questions/103408/symbol-for-corresponds-to-equals-sign-with-hat
\newcommand\equalhat{%
\let\savearraystretch\arraystretch
\renewcommand\arraystretch{0.3}
\begin{array}{c}
\stretchto{
    \scalerel*[\widthof{=}]{\wedge}
    {\rule{1ex}{3ex}}%
}{0.5ex}\\
=%
\end{array}
\let\arraystretch\savearraystretch
}

% ######################################################################################################################
%         Title and Header
% ######################################################################################################################

% ORCID
\newbox{\orcidlogo}
\sbox{\orcidlogo}{\large\includegraphics[height=1.8ex]{figures/logo-orcid.pdf}}
\newcommand{\orcid}[1]{\href{https://orcid.org/#1}{\usebox{\orcidlogo}\,}}

\addtokomafont{title}{\raggedright}
\addtokomafont{author}{\raggedright\setlength{\tabcolsep}{0pt}}
\addtokomafont{date}{\raggedright}

% Title Page
\title{Pool-Sequencing corrections for population genetic statistics}
% \subtitle{Genesis and Gappa: Library and Toolkit for \\Working with Phylogenetic (Placement) Data.}
\author{\orcid{0000-0002-1340-9644} Lucas Czech\textsuperscript{a,*}, \orcid{0000-0002-3199-1447} Jeffrey P. Spence\textsuperscript{b}, and \orcid{0000-0001-5711-0700} Moisés Expósito-Alonso\textsuperscript{a,c,d,*}}
\date{}

% ######################################################################################################################
%         Document
% ######################################################################################################################

\begin{document}

% \begin{abstract}
% abstract...
% \end{abstract}

% \beginsupplement
% \maketitle

\begingroup
\let\center\flushleft
\let\endcenter\endflushleft
\maketitle
\endgroup
\vspace*{-3.5em}
% Correspondence: 
% \href{mailto:moisesexpositoalonso@gmail.com}{moisesexpositoalonso@gmail.com},
% \href{mailto:luc@s-cze.ch}{luc@s-cze.ch}
\textsuperscript{a}{Department of Plant Biology, Carnegie Institution for Science, Stanford, USA.\\}
\textsuperscript{b}{Department of Genetics, Stanford University, Stanford, USA.\\}
\textsuperscript{c}{Department of Biology, Stanford University, Stanford, USA.\\}
\textsuperscript{d}{Department of Global Ecology, Carnegie Institution for Science, Stanford, USA.\\}
\textsuperscript{*}{To whom correspondence should be addressed: \href{mailto:lczech@carnegiescience.edu}{\color{black}{lczech@carnegiescience.edu}} and \href{mailto:moisesexpositoalonso@gmail.com}{\color{black}{moisesexpositoalonso@gmail.com}}}

% Custom title, as the template is a bit broken...
% \makeatletter
% {\LARGE \textbf{\@title}}
% It was written by \@author\space on \@date

% ######################################################################################################################
%         Supplement Text
% ######################################################################################################################

% \section*{Overview}
% \label{supp:sec:SoftwareComparison}

% \vspace*{0.6em}
% \\
\textbf{Version: 2022-06-02} \\
See \url{https://github.com/lczech/pool-seq-pop-gen-stats} for the latest version of this document.

This document describes our assessment of pool-sequencing-specific equations for population genetic measures of diversity (such as $\theta_\pi$, $\theta_\text{Watterson}$, Tajima's $D$), and differentiation (such as $\mathfst$).
The aim of these equations is to correct for biases of pool sequencing, specifically limited sample size (number of individuals pooled, or pool size~$\samplesize$) and limited coverage (number of reads obtained from those individuals, or coverage $\coverage$).

We re-render some approaches originally presented and implemented in \toolname{PoPoolation} \cite{Kofler2011a} and \toolname{PoPoolation2} \cite{Kofler2011b}, which are largely based on two sources:
\begin{itemize}
  \item The reverse-engineered code of \toolname{PoPoolation} and \toolname{PoPoolation2}. We want this document to represent the equations that are actually computed when running these programs, as we feel that they need a more thorough assessment than what is available in the current literature.
  \item The PoPoolation equations document \texttt{correction\_equations.pdf} as found in their code repository; we provide a copy at \url{https://github.com/lczech/popoolation/blob/master/files/correction_equations.pdf}. This document derives some of the equations implemented, but also contains equations that are not implemented in \toolname{PoPoolation} but may be of interest for a deeper understanding of the topic.
\end{itemize}

Furthermore, we derive two unbiased estimators for \fst{} for pool sequencing data, using two distinct definition of \fst{}, that correct for both biases described above.
Lastly, we evaluate the different estimators for \fst{} using simulated data, showing their particular biases.
All equations are implemented in our tool \href{https://github.com/lczech/grenedalf}{grenedalf}.

% ======================================================================================================
%          TOC
% ======================================================================================================

\tableofcontents

% ======================================================================================================
%          Definitions
% ======================================================================================================

\section{Preliminaries}
\label{supp:sec:Definitions}

% We here assume basic familiarity with pool sequencing concepts.
% Please refer to \citeay{Kofler2011a} for details on pool sequencing data and its biases.
% \todo{maybe we should cite some more sources here?}

% ------------------------------------------------------------------------------------------------------
%          Pool Sequencing
% ------------------------------------------------------------------------------------------------------

\subsection{Pool Sequencing Data and Notation}
\label{supp:sec:Definitions:sub:PoolSequencing}

We first define the input that we assume to be given for all subsequent equations.
In the software implementation of the equations, these are be based on the input data, or set by the user as parameters.

$\samplesize$ :
Pool size, provided by the user. This is the number of individuals that were pooled together for sequencing.

$\coverage$ :
Observed coverage. This is the number of reads sequenced from the pool that span a focal position in the genome. \todo{this being a sum of Cs, isn't that also a random variable, and should be captialized?}

$b$ :
Minimum allele count, provided by the user.
We do not want to consider SNPs with fewer than $b$ alternative reads in the data, as they might be sequencing errors.
Note that we assume $b$ to be a user-provided constant,
and hence leave it out of (most) function arguments for simplicity.

For most equations we will consider a single pool sequencing experiment, but in cases where we consider multiple experiments, we will denote the different experiments with subscripts in parentheses, such as $\samplesize_{(1)}, \samplesize_{(2)},\ldots$ or $\coverage_{(1)}, \coverage_{(2)}, \ldots$ to denote different populations.

Beyond these data-specific and user-specified parameters, we will use the following notation.  In general, we will use capital letters for random variables in our model of pool sequencing, which will be described shortly in \secref{supp:sec:FST}.  We will also differentiate sample quantities (\ie those that are computed from data) from their population counterparts (\ie parameters that describe the population from which the data were sampled) with hats.  For example, we differentiate the frequency of the $A$ allele in the whole population, $f_A$, from the empirical frequency of $A$ nucleotides in our pool sequencing sample, $\empfreq_A$.

$\tau$ :
Index over nucleotides, with $\tau \in \left\{ \text{A}, \text{C}, \text{G}, \text{T} \right\}$ being implicit in any summations.

$C_\tau$ :
Nucleotide counts, \ie, how many reads have a certain nucleotide $\tau$ at a given position in the genome.
Hence, we have $\coverage = \sum_\tau C_\tau$.

$f_\tau$ :
Nucleotide frequencies in the population, \ie the proportion of haplotypes that have nucleotide $\tau$ at the focal position.

$\empfreq_\tau$ :
Empirical nucleotide frequencies, \ie, $\empfreq_\tau := C_\tau / \coverage$. %\sfrac{c_\tau}{C}$

% $p$, $q$ :
% For biallelic SNP positions, we simplify and instead of the four $f_\tau$ values,
% just use $p$ for the frequency of the reference allele, and $q$ for the frequency of the alternative allele.

$m$ :
Index of summation over potential levels of coverage $\coverage$.

$k$ :
Index of summation over potential pool sizes $\samplesize$.

% $a$: (generalized) harmonic numbers

% $h$ : heterozygosity

% ------------------------------------------------------------------------------------------------------
%          Harmonic Numbers
% ------------------------------------------------------------------------------------------------------

We will also make use of the generalized harmonic numbers, which frequently arise in coalescent theory.   Define $a_1$ and $a_2$
as the sum of (squared) reciprocals of the first $m$ positive integers:
%
\begin{align}
    \label{eq:an}
    a_1(m) &:= \sum_{k=1}^{m} \frac{1}{k}
    \\
    \label{eq:bn}
    a_2(m) &:= \sum_{k=1}^{m} \frac{1}{k^2}
\end{align}
%


We use this notation as a compromise between Equation (3.6) of \citeay{Hahn2018} and the notation of $a_n$ and $b_n$ used in \citeay{Achaz2008} for these quantities.

\subsection{Statistical Model of Pool Sequencing}

We consider a simple model of pool sequencing as a series of multinomial samplings from a population.  In particular we assume the following model, where $N_\tau$ is the (unobserved) number of individuals in the pool with the $\tau$ allele:

\begin{align*}
(N_A, N_C, N_G, N_T) &\sim \text{Multinomial}\left(\samplesize, (f_A, f_C, f_G, f_T)\right)\\
(C_A, C_C, C_G, C_T) | (N_A, N_C, N_G, N_T) &\sim \text{Multinomial}\left(\coverage, \left(\frac{N_A}{\samplesize}, \frac{N_C}{\samplesize},\frac{N_G}{\samplesize},\frac{N_T}{\samplesize}\right)\right)
\end{align*}

Throughout, we will repeatedly make use of the following results:
\begin{align}
\mathbb{E}\left[\empfreq_\tau\right] = f_\tau, \label{eq:frequnbiased}
\end{align}
and
\begin{align}
\mathbb{E}\left[\left(\frac{\coverage}{\coverage-1}\right)\left(\frac{\samplesize}{\samplesize-1}\right)\left(1-\sum_\tau\empfreq_\tau^2\right)\right] = 1-\sum_\tau f_\tau^2. \label{eq:hetunbiased}
\end{align}

To see Equation~\ref{eq:frequnbiased} we can use the tower property:
\[
\mathbb{E}\left[\empfreq_\tau\right] = \mathbb{E}\left[\mathbb{E}\left[\empfreq_\tau \mid N_\tau \right]\right] = \mathbb{E}\left[\frac{N_\tau}{n}\right] = f_\tau.
\]
To obtain Equation~\ref{eq:hetunbiased}, we make use of the following fact about binomial distributions.  Suppose $X$ is binomially distributed with parameters $m$ and $p$, then $X$ can be represented as the sum of $m$ independent, identically distributed Bernoulli random variables, $Y_1,\ldots,Y_m$ that take the value $1$ with probability $p$ and $0$ with probability $1-p$.  We can then see:
\begin{align*}
\mathbb{E}\left[X(m-X)\right] &= \mathbb{E}\left[\sum_{i=1}^m\sum_{j=1}^mY_i(1-Y_j)\right]\\
&= m\mathbb{E}\left[Y_1(1-Y_1)\right] + m(m-1)\mathbb{E}\left[Y_1(1-Y_2)\right]
\end{align*}
where the second equality follows from the linearity of expectation, the fact that all of the $Y_i$s are identically distributed, and that $Y_i$ and $Y_j$ are independent if $i\ne j$.  Then, since $Y_i$ is either $0$ or $1$, $Y_i(1-Y_i)$ must be zero.  Finally, by independence,
\[
\mathbb{E}\left[Y_1(1-Y_2)\right] = \mathbb{E}\left[Y_1\right]\left(1-\mathbb{E}\left[Y_2\right]\right) = p(1-p).
\]
Therefore,
\[
\mathbb{E}\left[X(m-X)\right]  = m(m-1)p(1-p)
\]

We can now make use of this result twice along with the tower property to obtain Equation~\ref{eq:hetunbiased}:
\begin{align*}
\mathbb{E}\left[\left(\frac{\coverage}{\coverage-1}\right)\left(\frac{\samplesize}{\samplesize-1}\right)\left(1-\sum_\tau\empfreq_\tau^2\right)\right] &= \sum_\tau\left(\frac{\coverage}{\coverage-1}\right)\left(\frac{\samplesize}{\samplesize-1}\right) \mathbb{E}\left[\empfreq_\tau(1-\empfreq_\tau)\right]\\
&=  \sum_\tau\left(\frac{\coverage}{\coverage-1}\right)\left(\frac{\samplesize}{\samplesize-1}\right) \left(\frac{1}{\coverage^2}\right) \mathbb{E}\left[C_\tau\left(c-C_\tau\right)\right]\\
&= \sum_\tau\left(\frac{1}{\coverage(\coverage-1)}\right)\left(\frac{\samplesize}{\samplesize-1}\right) \mathbb{E}\left[\mathbb{E}\left[C_\tau\left(c-C_\tau\right) \mid N_\tau\right]\right]\\
&= \sum_\tau\left(\frac{\samplesize}{\samplesize-1}\right) \mathbb{E}\left[\frac{N_\tau}{\samplesize}\left(1-\frac{N_\tau}{\samplesize}\right)\right]\\
&= \sum_\tau\frac{1}{\samplesize(1-\samplesize)}\mathbb{E}\left[N_\tau\left(\samplesize - N_\tau\right)\right]\\
&= \sum_\tau f_\tau(1-f_\tau) = 1 - \sum_\tau f_\tau^2.
\end{align*}

The last equality holds as $\sum_\tau f_\tau = 1$.

% ======================================================================================================
%          Theta Pi
% ======================================================================================================

\section{Pairwise Heterozygosity \texorpdfstring{$\theta_\pi$}{}}
\label{supp:sec:ThetaPi}

First, we derive estimators for the pairwise heterozygosity, $\theta_\pi$, also called Tajima's $\pi$.  Formally, pairwise heterozygosity is the probability that two haploids drawn \emph{from the population} have different alleles at a position chosen uniformly at random.  We always assume that the population is large so that for a particular site, $\theta_\pi = 1 -\sum_\tau f_\tau^2$ which can be seen by noting that the probability that we pick two individuals with the $\tau$ allele is $f_\tau^2$.

If we were to sequence individuals, it would be straightforward to derive unbiased estimators for $\theta_\pi$, but instead we obtain a pool of reads, which introduces two major issues.  The first is that we no longer have access to individuals.  If we had sequenced individuals, we could estimate $\theta_\pi$ by looking at two individuals and asking if they have different alleles at a position, but in pool sequencing, we can only look at two different reads and ask if they have different alleles.  The issue is that we cannot know whether those reads were from the same individual or from different individuals, so a naive estimator of $\theta_\pi$ that just looks at pairwise differences between reads will be biased because in some fraction of times those reads will have come from the same individual, and hence must have the same allele (ignoring sequencing error).  The second major issue is that positions where only a small number of reads have a particular allele could be an artifact of sequencing error.  As such, PoPoolation restricts to sites where there are either $0$ or at least $b$ reads supporting each allele.

Below we derive PoPoolation's estimator of pairwise heterozygosity, $\thetapi$, which addresses both of the issues listed above.  Dealing with the bias from pool-sequencing is straightforward.  Restricting to positions where there are at least $b$ reads with the minor allele is more complex, however, and requires additional assumptions that will almost certainly not be met in practice.  In particular, the $\thetapi$ estimator crucially relies on the assumption that the population is evolving neutrally and is at equilibrium -- in technical terms, the derivation relies on the sample frequency spectrum to be proportional to $1/k$, which is to say that the probability that $k$ out of $\samplesize$ individuals have the derived allele at a segregating site has probability proportional to $1/k$.  In practice, natural selection, gene flow, or fluctuations in effective population size can all cause deviations from this assumption, and these deviations will result in $\thetapi$ being a biased estimator of $\theta_\pi$.

% ------------------------------------------------------------------------------------------------------
%          Unbiased Pool-seq estimator
% ------------------------------------------------------------------------------------------------------

% \subsection{Unbiased Pool-seq estimator of \texorpdfstring{$\theta_{\pi}$}{Theta Pi} for biallelic SNPs}
% \label{supp:sec:ThetaPi:sub:PoolSequencing}

\subsubsection*{PoPoolation Pool-seq estimator, $\thetapi$}
\label{supp:sec:ThetaPi:sub:PoolSequencing}

% % ------------------------------------------------------------------------------------------------------
% %     Definition for biallelic SNPs
% % ------------------------------------------------------------------------------------------------------
%
% \subsubsection*{Definition for biallelic SNPs}
% \label{supp:sec:ThetaPi:sub:PoolSequencing:sub:BasicDefinition}

PoPoolation begins by defining %
\begin{align}
    \label{eq:ThetaPiFreq2}
    \thetapi^{\samplesize\to\infty} &:= \frac{\coverage}{\coverage-1} \left(1 - \sum_\tau \empfreq_\tau^2 \right),
\end{align}
%
which is equal to the left hand side of Equation~\ref{eq:hetunbiased} up to a factor of $\frac{\samplesize}{\samplesize-1}$.  This indicates that this is a biased estimator of the heterozygosity at this site, but the bias is on the order of $O\left(\frac{1}{\samplesize}\right)$ which means that PoPoolation assumes an extremely large pool size, which is why we use the $\samplesize\to\infty$ superscript.

At this point, the PoPoolation equations document begins to simplify the above equation, and then breaks it down for biallelic SNPs. However, their (and our) implementation differs from this, and uses the above equation that works with any (not just biallelic) SNPs. We hence do not introduce these simplifications here.
% \todo{I thought a bit more about this. the heterozygosity is indeed computed from all four bases. BUT: the below equations are still assuming biallelic SNPs! is that a problem?! it's solvable by just using biallelic snps as in the computation -- but what would it mean theoretically to use this correction for non-biallelic snps?  JPS: their whole correction assumes that the mutation rate is vanishingly small so that you should (almost) never see non-biallelic SNPs.  In practice, I would think that multi-allelic SNPs would actually be quite rare and so shouldn't be something we worry about too much.}
Note however that the computation is still only conducted on biallelic sites, as the correction term introduced below assumes this. This means, we are assuming that multiallelic sites are rare, which is true for small mutation rates.

\popoolissue{We think that it is makes sense to compute only on biallelic SNPs, as this is a theoretical derivation of $4N_e\mu$, which assumes the infinitesimal model (which does not allow for multi-allelic loci). Still, we briefly wanted to check in with you here. Our guess is that the computation in code is just done for all four nucleotides to keep the code simple -- but the function only gets called for biallelic sites, so it behaves as if it was only computed for biallelic SNPs. Is that right?}

% \todo{(Moi) I think it is fine that below it assumes biallelic SNPs. It is a theoretical derivation of 4Neu, one of which assumptions is the infinitesimal model (a mutation is unlikely to happen two times in the same place, so multiallelic loci are assumed impossible). JPS: yes! exactly!}

% ------------------------------------------------------------------------------------------------------
%    Expected value of population mutation rate $\theta$ from nucleotide diversity
% ------------------------------------------------------------------------------------------------------

\subsubsection*{Bias of $\thetapi^{\samplesize\to\infty}$ when restricting to sites with at least $b$ minor allele reads}
\label{supp:sec:ThetaPi:sub:PoolSequencing:sub:ExpectedValue}

Other than the bias from the finite pool size, $\thetapi^{\samplesize\to\infty}$ is a reasonable estimator of the pairwise heterozygosity at a given site.  To obtain an overall estimate of $\theta_\pi$, we could average $\thetapi^{\samplesize\to\infty}$ across all sites.  PoPoolation seeks to avoid including sites that appear to be segregating solely because of sequencing error, however, which adds a complication.  We expect that sequencing errors should be rare, and so it would be extremely unlikely to see more than $b$ reads supporting a particular allele solely due to sequencing error.  As such, we can remove all sites with fewer than $b$ reads supporting the minor allele.  This is problematic, however, and biases the estimator -- while removing such sites certainly removes most or all sites that are segregating solely due to sequencing error, it also removes a large number of sites where the mutation just happens to be at low frequency.

The approach that PoPoolation takes is to assume neutrality and an equilibrium demography (all variation is neutral, and the population is of constant size and in mutation-drift equilibrium), calculate the bias of $\thetapi^{\samplesize\to\infty}$, and introduce a term to correct for that bias.  Despite using sequencing error as a motivation, PoPoolation ignores sequencing error in the following derivation.  The derivation will assume biallelic sites, and all expectations in this section will be with respect to both the randomness in the pool-seq experiment as well as the randomness in the evolutionary process.  To begin, we compute the expectation of $\thetapi^{\samplesize\to\infty}$ when restricted to only sites where there are either $0$ or at least $b$ reads supporting the minor allele.  Since we are assuming that we are only looking at biallelic sites, we will use $M$ to denote the number of reads supporting the derived allele.  Note that if $M$ is zero or $\coverage$, then $\thetapi^{\samplesize\to\infty} = 0$. Letting $\mathcal{E}_b$ be the event that either $0$ or at least $b$ reads support the minor allele, we see
%
\begin{align}
\mathbb{E}\left[\thetapi^{\samplesize\to\infty} \mid \mathcal{E}_b\right] &= \sum_{m=b}^{\coverage-b} \mathbb{E}\left[\thetapi^{\samplesize\to\infty} \mid M=m \right] \mathbb{P}(M = m)\\
&= \mathbb{P}\left(\text{Site is a SNP}\right)\sum_{m=b}^{\coverage-b} \mathbb{E}\left[\thetapi^{\samplesize\to\infty} \mid M=m \right] \mathbb{P}\left(M = m \mid \text{Site is a SNP}\right)\\
&=  2\mathbb{P}\left(\text{Site is a SNP}\right)\sum_{m=b}^{\coverage-b} \frac{m(\coverage-m)}{\coverage(\coverage-1)} \mathbb{P}\left(M = m \mid \text{Site is a SNP}\right)
\label{eq:ExpectationThetaPi}
% \mathbb{E}(\theta_\pi|C) &= P(\mbox{SNP} | n) \cdot \sum_{m=b}^{C-b} \frac{2m (C-m)}{C(C-1)} \cdot P(m|C,n)
% \\
% &= P(\mbox{SNP} | n) \cdot \frac{2}{C(C-1)} \cdot \sum_{m=b}^{C-b} m(C-m) \cdot P(m|C,n)
\end{align}
%
In words, the expected value is computed by summing all possible SNP counts (that exceed the minimum count $b$)
that can occur in a pool with coverage $\coverage$,
weighted by the probability to have each of those counts.

As we are using the derived allele count $m$ in the equation above,
and either the derived or ancestral allele could be the minor allele,
we ``sandwich'' our potential values for the coverage between $b$ and $\coverage-b$.

The two probabilities used above are computed as follows.

$\mathbb{P}\left(\text{Site is a SNP}\right)$ is the probability of observing a SNP in our pool of $\samplesize$ individuals.  Here we invoke our neutrality and equilibrium assumptions, where a classical result from coalescent theory gives:
%
\begin{align}
\label{eq:PSNP}
\mathbb{P}\left(\text{Site is a SNP}\right) = 1- \prod_{k=1}^{\samplesize-1} \frac{1}{1+\frac{\theta_\pi}{k}} \approx \theta_\pi a_1(n-1)
\end{align}

where the final approximation ignores terms on the order of  $\theta_\pi^2$, which implicitly assumes that the mutation rate is small.

$\mathbb{P}\left(M = b | \text{ Site is a SNP }\right)$ is the probability of observing $m$ as the derived allele count in a SNP with $\coverage$ reads from a pool of $n$ individuals.  We can further break this down by conditioning on the number of individuals in the pool that have the derived allele, which we will call $\tilde{M}$:
%
\begin{align}
    \label{eq:Pmcn}
    \mathbb{P}\left(M = m \mid \text{site is a SNP}\right) &= \sum_{k=1}^{n-1} \mathbb{P}\left(M=m \mid \tilde{M} = k\right)\mathbb{P} \left( \tilde{M} = k\right)\\
    %&= \sum_{k=1}^{n-1} P(m|C,n,k) \frac{1/k}{\sum_{j=1}^{n-1} 1/j} \\
    &= \frac{1}{a_1(n-1)}  \sum_{k=1}^{n-1} \frac{1}{k}  \mathbb{P}\left(M=m \mid\tilde{M} = k\right)
\end{align}
where the second line follows from another classic result in coalescent theory that (assuming neutrality, equilibrium, and that $\theta_\pi$ is small) the probability that $k$ individuals in a pool of size $\samplesize$ is $\frac{1}{ka_1(n-1)}$.

Finally, $ \mathbb{P}\left(M=b \mid \tilde{M} = k\right)$ is the probability of having $m$ reads support the derived allele when $k$ individuals in the pool have the derived allele.  From our binomial sampling model of pool sequencing, this is:

%
\begin{align}
    \label{eq:Pmcnk}
     \mathbb{P}\left(M=b \mid \tilde{M} = k\right) &= \binom{\coverage}{m} \left(\frac{k}{\samplesize}\right)^m \left(\frac{\samplesize-k}{\samplesize}\right)^{\coverage-m}
\end{align}
%
In words, this follows a binomial distribution, with $m$ successes out of $c$ trials
with a success probability of $k/n$ for each trial.
That is, we compute how likely it is to observe $m$ as the first/major allele count in $c$ reads,
given the frequency $k/n$ of the major allele in the pool.
The count of the second/minor allele is implicitly used here as $c-m$.

Starting from \eqnref{eq:ExpectationThetaPi}, we can now put this together:
%
\begin{align}
\nonumber
\mathbb{E}\left[\thetapi^{\samplesize\to\infty} \mid \mathcal{E}_b\right]  &=2\theta_\pi \sum_{m=b}^{\coverage-b} \frac{m(\coverage-m)}{\coverage(\coverage-1)} \sum_{k=1}^{n-1} \frac{1}{k} \binom{\coverage}{m} \left(\frac{k}{\samplesize}\right)^m \left(\frac{\samplesize-k}{\samplesize}\right)^{\coverage-m}
\end{align}

This shows that if we use our estimator $\thetapi^{\samplesize\to\infty}$ but only apply it to sites where the minor allele is supported by at least $b$ reads, then estimate will be biased by a factor of
\[
2\sum_{m=b}^{\coverage-b} \frac{m(\coverage-m)}{\coverage(\coverage-1)} \sum_{k=1}^{n-1} \frac{1}{k} \binom{\coverage}{m} \left(\frac{k}{\samplesize}\right)^m \left(\frac{\samplesize-k}{\samplesize}\right)^{\coverage-m}
\]

which we will now use to elimiate said bias.

%@\todo{Jeff, Lucas I think there is still something weird in the substitution of the P(SNP given n). As it is written using Theta= S/an, the substitution is not a probability but the number of segregating sites}


% ------------------------------------------------------------------------------------------------------
%     Final approximation for population mutation rate Theta
% ------------------------------------------------------------------------------------------------------

\subsubsection*{Unbiased estimate of $\theta_\pi$ when restricting to sites with at least $b$ minor allele reads}
\label{supp:sec:ThetaPi:sub:PoolSequencing:sub:FinalApprox}

Based on the previous section, we can construct an unbiased estimator for $\theta_\pi$ when restricting to sites with at least $b$ reads supporting the minor allele, which we denote by $\widehat{\theta}_{\pi,\text{pool}}$.  Let $\mathcal{S}_b$ be the set of sites where at least $b$ reads support the minor allele, and let $\thetapi^{\samplesize\to\infty}(\ell)$ be the above estimator evaluated at the $\ell^\text{th}$ site (where above we suppressed the dependence on site because we only considered one site at a time).  We then define  $\widehat{\theta}_{\pi,\text{pool}}$ as
%
\begin{align}
    \label{eq:ThetaPiPoolEstimate}
     \widehat{\theta}_{\pi,\text{pool}} &:=
    \frac{
       \frac{1}{|\mathcal{S}_b|}\sum_{\ell \in \mathcal{S}_b} \thetapi^{\samplesize\to\infty}(\ell)
    }{
        2\sum_{m=b}^{\coverage-b} \frac{m(\coverage-m)}{\coverage(\coverage-1)} \sum_{k=1}^{n-1} \frac{1}{k} \binom{\coverage}{m} \left(\frac{k}{\samplesize}\right)^m \left(\frac{\samplesize-k}{\samplesize}\right)^{\coverage-m}
%         \sum_{k=1}^{n-1} \frac{1}{k}  {C \choose m} \left(\frac{k}{n}\right)^m \left(\frac{n-k}{n}\right)^{C-m}
    }
\end{align}
%
Note that the denominator only depends on the total coverage $\coverage$ and the pool size $\samplesize$,
and hence only needs to be computed once per coverage level, yielding a significant computational speedup.

\todo{Hey Jeff, I think we need to change the above a bit. In the denominator, the coverage $c$ can be different per site, and hence needs to be evaluated at each site individually. Hence, in my original forumation of this, I just gave the equation for a single site, and then said that they are summed over all sites. Shall I change it back to that?}

This is the equation as implemented in \toolname{PoPoolation} as the measure called \texttt{pi},
and implemented in our \toolname{grenedalf} as well.


% \begin{align}
%  \mathbb{E}(\theta_\pi,c) = \theta a_1(n) \frac{C}{C-1}\sum_{m=b}^{C-b}\left( 1 -
% \left(\frac{m}{C}\right)^2 \right) \cdot \sum_{k=1}^{n-1} {C \choose m} \left(\frac{k}{n}\right)^m \left(\frac{n-k}{n}\right)^{C-m}  \frac{1}{k} \frac{1}{a_1(n)}
% \end{align}
%
% \begin{align}
% \mathbb{E}(\theta_\pi|C) &= P(\mbox{SNP} | n) \cdot \sum_{m=b}^{C-b} \frac{2m (C-m)}{C(C-1)} \cdot P(m|C,n)
% \\
% &= \theta \cdot a_1(n) \cdot \sum_{m=b}^{C-b} \frac{2m (C-m)}{C(C-1)} \cdot \frac{1}{a_1(n)} \sum_{k=1}^{n-1} \frac{1}{k} P(m|C,n,k) \\
% &= \theta \cdot a_1(n) \cdot \sum_{m=b}^{C-b} \frac{2m (C-m)}{C(C-1)} \cdot \frac{1}{a_1(n)} \sum_{k=1}^{n-1} \frac{1}{k} {C \choose m} \left(\frac{k}{n}\right)^m \left(\frac{n-k}{n}\right)^{C-m}
% \end{align}

% \clearpage

% ------------------------------------------------------------------------------------------------------
%          Computation in Windows
% ------------------------------------------------------------------------------------------------------

% \subsection{Computation in Windows}
% \label{supp:sec:ThetaPi:sub:Windows}

% not much to say here, so moved to above

% % ------------------------------------------------------------------------------------------------------
% %          Simplified Theta Pi
% % ------------------------------------------------------------------------------------------------------

% \subsection{Simplified Theta Pi}
% \label{supp:sec:ThetaPi:sub:Simplified}

% Not sure if needed.

% PoPoolation notes: also good for individual sequencing

% ======================================================================================================
%          Theta Watterson
% ======================================================================================================

\section{Watterson's Theta \texorpdfstring{$\widehat{\theta}_w$}{}}
\label{supp:sec:ThetaWatterson}

\todo{this section name has a hat, while the previous theta pi section name does not. Jeff, which one do you prefer?}

% ------------------------------------------------------------------------------------------------------
%          Theta Watterson
% ------------------------------------------------------------------------------------------------------

% \subsection{Pool-Sequencing Correction}
% \label{supp:sec:ThetaWatterson:sub:PoolSequencing}

Under neutrality, and equilibrium demography $\theta_\pi$ is equal to $4N_e\mu =: \theta$ -- four times the effective population size times the per-generation mutation rate, and hence, the estimator in the previous section can be used as an estimate of the population-scaled mutation rate.  An alternative estimate of the mutation rate is Watterson's theta, $\widehat{\theta}_w$, which is based on the number of segregating sites instead of the pairwise heterozygosity.  If we had sequenced individuals, the usual definition of $\widehat{\theta}_w$ is (e.g., Equation (3.5) of \citeay{Hahn2018}):
\[
\widehat{\theta}_w := \frac{S}{a_1(n-1)}
\]
\todo{pretty sure that the $n$ in the denominator above is wrong, as $n$ is the pool size, but it should be coverage, or not? Jeff, can you please check?}
where $S$ is the number of segregating sites.  In the pool sequencing case we might hope to just count up the number of sites that have more than one allele to use in place of $S$, but sequencing error is deeply problematic here.  Any place where any read has a sequencing error will look like a segregating site, vastly inflating our estimate of the true number of sites that are segregating in our sample.  PoPoolation therefore follows a similar approach as in the case of the pairwise heterozygosity, by only considering a site to be segregating if at least $b$ reads support each of two alleles.  Again, this restriction introduces bias because it will miss many sites where one of the alleles really is at a low frequency -- but still segregating -- in the pool.  As before, we will compute this bias and then correct for it, again assuming neutrality, and equilibrium demography, and that the mutation rate is small enough to only focus on biallelic sites.


Formally, let $M_\ell$ be the number of reads supporting the derived allele site $\ell$, and define
\begin{align}
%     \nonumber
    S_b(\ell) :=
    \begin{cases}
        1 & \text{if } b \le M_\ell \le \coverage-b
        \\
        0 & \text{otherwise}
    \end{cases}
\end{align}
%

We then define our naive pool-seq analog of Watterson's $\theta$ as
\[
\widehat{\theta}_w :=\frac{1}{a_1(\samplesize-1)}\sum_{\ell} S_b(\ell)
\]
\todo{again, sure that this is $n$ here? same below again.}

Reasoning the same as above, we get the expected value of $\widehat{\theta}_w$ as
%
\begin{align}
    \nonumber
    \mathbb{E}\left[\widehat{\theta}_w\right]
    &= \frac{1}{a_1(\samplesize-1)} \cdot \mathbb{P}\left(\text{Site is a SNP}\right)
        \cdot \sum_{m=b}^{\coverage-b} \mathbb{P}\left(M = m \mid \text{Site is a SNP}\right)
    \\
    \intertext{
        with the two probability terms again as in \eqnref{eq:PSNP} and \eqnref{eq:Pmcn}, thus leading to
    }
    \label{eq:ExpecationThetaW}
    &= \theta \sum_{m=b}^{\coverage-b}\sum_{k=1}^{n-1} \frac{1}{k} \binom{\coverage}{m} \left(\frac{k}{\samplesize}\right)^m \left(\frac{\samplesize-k}{\samplesize}\right)^{\coverage-m}
\end{align}
%
This immediately suggests the following unbiased estimator, which we denote $\widehat{\theta}_{w, \text{pool}}$:
%
\begin{align}
    \label{eq:CorrectedThetaEstimate}
    \widehat{\theta}_{w, \text{pool}} &:=
    \frac{
        \widehat{\theta}_w
    }{
         \sum_{m=b}^{\coverage-b}\sum_{k=1}^{n-1} \frac{1}{k} \binom{\coverage}{m} \left(\frac{k}{\samplesize}\right)^m \left(\frac{\samplesize-k}{\samplesize}\right)^{\coverage-m}
    }
\end{align}
%
\todo{I don't think the above is correct. it is using $\widehat{\theta}_w$ in the numerator, which contains the additional $a_1$ term that is not meant to be there, as it cancels out. Jeff, can you check please?}

As before, the denominator only depends on the coverage $\coverage$,
and hence only needs to be computed once per coverage level that is present in the data.

Again, the approach to compute this for a window is to sum up all values across the SNPs in the window.
This is the equation as implemented in \toolname{PoPoolation} as the measure called \texttt{theta},
and implemented in our \toolname{grenedalf} as well.

% ------------------------------------------------------------------------------------------------------
%          Simplified Theta Watterson
% ------------------------------------------------------------------------------------------------------

% \subsection{Simplified Theta Watteron}
% \label{supp:sec:ThetaWatterson:sub:Simplified}

% Not sure if needed.

% PoPoolation notes: also good for individual sequencing

% ======================================================================================================
%          Tajima's D
% ======================================================================================================

\section{Tajima's D}
\label{supp:sec:TajimaD}

Above, we have defined pool-sequencing corrected estimators $\widehat{\theta}_{\pi,\text{pool}}$ and $ \widehat{\theta}_{w, \text{pool}}$.
Now, we want to use them to define a test akin to Tajima's D for pool sequencing.
We are here again following the PoPoolation approach, and re-derive their equations.

% ------------------------------------------------------------------------------------------------------
%          Pool-Sequencing Correction
% ------------------------------------------------------------------------------------------------------

\subsection{Pool-Sequencing Correction}
\label{supp:sec:TajimaD:sub:PoolSequencingCorrection}

The PoPoolation equations document derives the following estimator.
To the best of our knowledge, this is however not implemented in \toolname{PoPoolation};
instead, they compute Tajima's D as presented in the following \secref{supp:sec:TajimaD:sub:Classic}.
We still introduce the approach here, for reference, and in the hope that it might be helpful.

First, we define:
%
\begin{align}
    \widehat{d}_\text{pool} ~&:=~ \widehat{\theta}_{\pi,\text{pool}} ~-~ \widehat{\theta}_{w, \text{pool}}
\end{align}
%
and use this to define our statistic:
%
\begin{align}
    D_\text{pool} ~&:=~ \frac{ \widehat{d}_\text{pool} }{ \sqrt{ \widehat{\text{Var}}( \widehat{d}_\text{pool}) }},
\end{align}
%
with a plug-in estimate of the variance of $ \widehat{d}_\text{pool}$.
To derive this plug-in estimate of the variance, we start with the standard expansion of the variance:
%
\begin{align}
    \nonumber
    \text{Var}( \widehat{d}_\text{pool} ) &= \mathbb{E}\left[ \widehat{d}_\text{pool}^2 \right] - \mathbb{E}\left[\widehat{d}_\text{pool}\right]^2
\end{align}
%
At this point, we use that $\mathbb{E}[\widehat{d}_\text{pool}] = 0$ (i.e., unbiased) for populations at equilibrium, since both $\widehat{\theta}_{\pi,\text{pool}}$ and $\widehat{\theta}_{w, \text{pool}}$ are unbiased estimates of $\theta$.  Therefore, $\mathbb{E}[\widehat{d}_\text{pool}]^2 = 0$.

Then, following PoPoolation, we compute the variance as:

\begin{align}
    \nonumber
    \text{Var}( \widehat{d}_\text{pool} ) &= \mathbb{E}( \widehat{d}_\text{pool}^2 )
    \\
    \nonumber
    &= \mathbb{P}\left(\text{Site is a SNP}\right) \sum_{m=b}^{C-b} \mathbb{E}\left[\widehat{d}_{\text{pool}}^2 \mid M=m \right] \cdot \mathbb{P}\left(M = m \mid \text{Site is a SNP}\right)
    \intertext{which can be resolved using equations \eqnref{eq:PSNP} and \eqnref{eq:Pmcn} from previous sections:}
    \label{eq:VarDPool}
    &= \theta \sum_{m=b}^{C-b}  \mathbb{E}\left[\left(\widehat{\theta}_{\pi,\text{pool}} -  \widehat{\theta}_{w,\text{pool}} \right)^2 \Big\vert\ M=m\right]    \cdot \sum_{k=1}^{n-1} \frac{1}{k}  \binom{C}{m} \left(\frac{k}{n}\right)^m \left(\frac{n-k}{n}\right)^{C-m}
\end{align}
%
Both $\widehat{\theta}_{\pi,\text{pool}}$ and $\widehat{\theta}_{w, \text{pool}}$ are completely determined once we fix $M$ to be $m$, so the only unknown quantity is $\theta$.
PoPoolation suggests using $\widehat{\theta}_{\pi,\text{pool}}$
on the same window on which we are computing $D_\text{pool}$, as our estimate of $\theta$ to obtain a plug-in estimate of the variance:
\[
\widehat{\text{Var}}( \widehat{d}_\text{pool} )  := \widehat{\theta}_{\pi, \text{pool}} \sum_{m=b}^{C-b} \mathbb{E}\left[\left(\widehat{\theta}_{\pi,\text{pool}} -  \widehat{\theta}_{w,\text{pool}} \right)^2 \Big\vert\ M=m\right]
    \cdot \sum_{k=1}^{n-1} \frac{1}{k}  \binom{C}{m} \left(\frac{k}{n}\right)^m \left(\frac{n-k}{n}\right)^{C-m}
\]

This assumes that all individuals contribute the same number of reads to the pool.
As stated above, both $\widehat{\theta}_{\pi,\text{pool}}$ and $\widehat{\theta}_{w, \text{pool}}$ are completely determined once we fix $M$ to be $m$, so these values can be pre-computed and stored to achieve a computational speedup.

The first summation in \eqnref{eq:VarDPool} involves computing $\widehat{\theta}_{\pi,\text{pool}}$ and 
$\widehat{\theta}_{w,\text{pool}}$ repeatedly $C-2b$ many times, 
with each of these computations involving to compute their respective denominators.
% as shown in \eqnref{eq:ThetaPiPool} and \eqnref{eq:ThetaWPool}.
However, as $C$ remains constant throughout this computation, these denominators (the correction terms)
are identical, so that we only need to compute them once, to gain a $\approx C$-fold speedup.

At this point, the PoPoolation equation document also introduces an approach to compute Tajima's D based on the above in windows.
We here skip this part for brevity.

% \begin{align}
% D_{\text{pool}} &= \frac{ \theta_{\pi,\text{pool}} - \theta_{w,\text{pool}}
% }{ \sqrt{\text{Var}( \theta_{\pi,\text{pool}} - \theta_{w,\text{pool}} ) }}
% \\
% \text{Var}( \theta_{\pi,\text{pool}} - \theta_{w,\text{pool}} ) &=
% \\\\
% d_{\text{pool}} &= \theta_{\pi,\text{pool}} - \theta_{w,\text{pool}}
% \\
% D_{\text{pool}} &= \frac{ d_{\text{pool}}}{ \sqrt{\text{Var}( d_{\text{pool}} ) }}
% \\
% \text{Var}( d_{\text{pool}} ) &= \mathbb{E}(d_{\text{pool}}^2) - \mathbb{E}(d_{\text{pool}}) ^2
% \end{align}

% ------------------------------------------------------------------------------------------------------
%          Computation in Windows
% ------------------------------------------------------------------------------------------------------

% \subsection{Computation in Windows}
% \label{supp:sec:TajimaD:sub:Windows}

% \todo{not sure if needed}

% \todo{@Lucas. If implemented, please add}

% ------------------------------------------------------------------------------------------------------
%          Integration with Classic D
% ------------------------------------------------------------------------------------------------------

\subsection{Integration with Classic Tajima's D}
\label{supp:sec:TajimaD:sub:Classic}

On large windows, the classic Tajima's D is not a measure of significance (in number of standard deviations away from the null hypothesis), but instead is a measure of the magnitude of the divergence from neutrality.
This is because all loci are considered completely linked, even if they are not in reality.

However, the above pool-sequencing Tajima's D instead consideres all loci as completely unlinked.
This ignores positive correlations between linked sites, so it gives a different numerical result that has a much higher absolute value compared to classic Tajima's D.

Now, we want to obtain a correction term for the pool-sequence Tajima's D to obtain values that are comparable to classic Tajima's D in non-small windows, that is, we want a measure of the magnitude of the divergence from neutrality.
We again follow the PoPoolation approach, and here derive the equations that are actually implemented.

% ------------------------------------------------------------------------------------------------------
%      Approach by Achaz
% ------------------------------------------------------------------------------------------------------

\subsubsection*{Approach by Achaz}

To this end, PoPoolation2 uses a modified version of the $Y^*$ test of \citeay{Achaz2008},
which was originally developed as a test for neutrality despite the presence of sequencing errors.
This test only works when excluding singletons, that is, we set $b:=2$ for this part.

Following PoPoolation and \citeay{Achaz2008}, we first define:
%
\begin{align}
f^*(n) &:= \frac{n-3}{a_1(n-1) \cdot (n-1)-n}
% \\
% \nonumber
\intertext{which is then used to define:}
% \\
\alpha^*(n) &:= f^{*2} \cdot\left( a_1(n-1) - \frac{n}{n-1} \right) + f^* \cdot\left( a_1(n-1) \cdot \frac{4(n+1)}{(n-1)^2} - 2 \cdot\frac{n+3}{n-1} \right) - a_1(n-1) \cdot\frac{8(n+1)}{n(n-1)^2} + \frac{n^2+n+60}{3n(n-1)}
% \\
% \nonumber
\intertext{and:}
% \\
\nonumber
\beta^*(n) &:= f^{*2} \cdot\left( a_2(n-1) - \frac{2n-1}{(n-1)^2} \right) + f^* \cdot\left( a_1(n-1) \cdot \frac{8}{n-1} - a_1(n-1) \cdot\frac{4}{n(n-1)} - \frac{n^3 + 12n^2 -35n +18}{n(n-1)^2} \right) \\
\label{eq:betastar}
&- a_1(n-1) \cdot\frac{16}{n(n-1)} + a_1(n-1) \cdot\frac{8}{n^2(n-1)} + \frac{2(n^4 + 110n^2 -255n + 126)}{9n^2(n-1)^2}
\end{align}
%
Note that these equations were originally developed for data from individuals,
and hence here, $n$ denotes the number of individuals \emph{as if} we were doing individual sequencing.

NB: The PoPoolation document recommends to counter-check the correctness of their equation
with the original of \citeay{Achaz2008}.
In fact, PoPoolation introduced a slight mistake in the last term of $\beta^*$,
which we have fixed here. Above is the (hopefully) correct one, following \citeay{Achaz2008}.
Note that the mistake only concerns the PoPoolation equations document, but not their implementation.

\popoolissue{The above is indeed not a big one, but we thought it's good to mention it.}

\popoolissue{A more serious issue occurred in the computation of alpha*. The code actually computes this as beta*, and never calls the actual alpha* function, see \href{https://github.com/lczech/popoolation/blob/092e7a6f7ee4910c1bec4377e0adccc353175bc8/Modules/VarMath.pm\#L104}{here}. This is a bug that Robert and I have discussed before, and I think it is fixed now.}

\popoolissue{Another small issue: The computation of alpha* requires ``effective coverage'' to be larger than 1, see \href{https://github.com/lczech/popoolation/blob/092e7a6f7ee4910c1bec4377e0adccc353175bc8/Modules/VarMath.pm\#L226}{here}, but tests this against $n$, which is the number of individuals. Are we missing something here?}

\popoolissue{Furthermore, we tested the computation of alpha*, and it also gives NaN values for input 2 and 3, so the test should in fact be $>= 4$ instead.}

% ------------------------------------------------------------------------------------------------------
%     The number of individuals sequenced
% ------------------------------------------------------------------------------------------------------

\subsubsection*{The number of individuals sequenced}

The only unresolved parameter is $n$, which corresponds to the number of individuals sequenced --
if we were to do individual sequencing.
In our case of pool sequencing, according to PoPoolation,
we can reasonably substitute this with the expected number of distinct individuals sequenced.

To this end, we use the coverage $\coverage$, as well as the pool size $n$, which we here use as our substitute for the number of individuals sequenced.
% \todo{I have no idea what this distinction between $n$ and $n$ is about, and the PoPoolation document does not explain this at all... It might be that $n$ is meant to be the $n$ (pool size) from previous sections, but $n$ here is used as the parameter for $f^*$ instead?!}
Then, we define $\tilde{n}$ as the expected number of individuals from our pool that have been sequenced:
%
\begin{align}
    \label{eq:IndivSeqBruteForce}
    \tilde{n}
%     &= \sum_{k=1}^{\text{max}(C, n)} k \cdot \frac{{n \choose k} \sum_{j=1}^{k} (-1)^{k-j} {k \choose j} j^C }{n^C}
    &= \sum_{k=1}^{t} \sum_{j=1}^{k} (-1)^{k-j} \cdot k \binom{n}{k} \binom{k}{j} \left(\frac{j}{n}\right)^\coverage
\end{align}
%
where $t=\text{max}(\coverage, n)$; if $n$ is much larger than $\coverage$, we can assume $\tilde{n} \approx \coverage$.
% Our substitute $\tilde{n}$ is then obtained by averaging $\tilde{n}$ over the window $W$.

\popoolissue{We think that there is either an error here, or a bug in the code. The code in PoPoolation actually uses the minimum of coverage and pool size in the above, instead of the maximum as stated above, see \href{https://github.com/lczech/popoolation/blob/092e7a6f7ee4910c1bec4377e0adccc353175bc8/Modules/VarMath.pm\#L156}{here}. We are not sure which one is correct though, or what the implications of this are.}

\popoolissue{Furthermore, the original equations document states that ``$\tilde{n}$ is obtained averaging $\tilde{n}$ over the window W'', which we also stated above. However, looking at the code \href{https://github.com/lczech/popoolation/blob/092e7a6f7ee4910c1bec4377e0adccc353175bc8/Modules/VarMath.pm\#L127}{here}, there is no averaging over the window, and instead it's just computed once. The function for averaging exists in the same PoPoolation function as well, see \href{https://github.com/lczech/popoolation/blob/092e7a6f7ee4910c1bec4377e0adccc353175bc8/Modules/VarMath.pm\#L117-L125}{here}, but is commented out, and also contains a bug, as \texttt{\$cov} is not used. We are unsure how much averaging over the window vs just one value actually changes the results, and hence wanted to bring it up here.} 

Computing the expected number of distinct individuals sequenced corresponds to the following statistical question:
Given a set of integers $A = \{1, \ldots, n\}$ (corresponding to individuals),
pick a set $B$ of $C$ elements from set $A$ with replacement (corresponding to reads);
what is the expected number of distinct values (individuals) that have been picked in $B$ (that we have reads from)?

PoPoolation computes this value by brute force using \eqnref{eq:IndivSeqBruteForce},
that is, by trying all possible ways to pick numbers from the set.
However, there exists a closed form solution to this question, which yields massive speedups for larger coverages, which we have implemented.

One way to arrive at the closed form expression is as follows:
% https://math.stackexchange.com/questions/5775/how-many-bins-do-random-numbers-fill
Define an indicator random variable $I_i$ for $1 \leq i \leq n$ as $1$
if individual $i$ is present in the set $B$ (that is, if individual $i$ has been sequenced), and as $0$ if not.
Then, the size of set $B$ is simply $\sum_{i=1}^{n} I_i$.

The probability that $I_i$ equals $1$ (that is, that individual $i$ has been sequenced)
for any $i$ is given by:
%
\begin{align}
    P(I_i = 1) &= 1-\left( \frac{n-1}{n} \right)^\coverage
\end{align}
%
In words, this is the complement of \emph{not} picking $i$ in all of the $\coverage$ picks from set $A$.

The expected size of the set $B$ can then be computed by linearity of expectation for all $i$,
yielding our closed form expression:
%
% $n \left[ 1- \left( 1 - \frac{1}{n} \right)^n \right]$.
% Hence, we compute $\tilde{n}$ as:
%
\begin{align}
    \tilde{n} = n \left( 1 - \left( \frac{n-1}{n} \right)^\coverage \right)
\end{align}
%
This is equation that we compute in our implementation to arrive at $\tilde{n}$ for a given coverage $\coverage$ and poolsize $n$.

\todo{UNRESOLVED ISSUE: This is computed using the coverage $\coverage$ in the above equations (and in the PoPoolation equations), but seems to be called with $b$ (min coverage) in their code (and in mine). Jeff, is that yet another bug (number three then, on top of the two already mentioned two sections below) that they introduced in their code? it seems weird to compute this based on the min coverage, than the actual coverage at the site.  JPS: I'm actually not totally sure what the PoPoolation people are doing here.  I guess they're plugging an estimate of $n$ into the f alpha and beta, which is fine, but could be biased.  My guess is that you would want to use $\coverage$ and not $b$, but as I said I'm not totally sure what they're doing here.}

% Keeping the popoolation issues here for later reference.

\popoolissue{Here seem to be more issues in the PoPoolation code. Looking again at the line where the call to compute $n_\text{base}$ is located, \href{https://github.com/lczech/popoolation/blob/092e7a6f7ee4910c1bec4377e0adccc353175bc8/Modules/VarMath.pm\#L127}{here}, the function is called with the min coverage, instead of the actual coverage as stated in the equations here. We are not sure what effect this has, but think that this is an issue.}

\popoolissue{Furthermore, that call to \texttt{nbase\_buffer} takes two arguments, \texttt{\$n} and \texttt{\$mincoverage}, but the inner function of \texttt{get\_nbase\_buffer} only does one \texttt{shift}, hence ignoring the second argument. Robert changed that line after our conversation, but I am not sure that everything is fixed yet, see below.}
 
\popoolissue{At this point also, see \href{https://github.com/lczech/popoolation/blob/092e7a6f7ee4910c1bec4377e0adccc353175bc8/Modules/VarMath.pm\#L145}{here}, the variable is again called \texttt{\$cov}, indicating that we want to take the coverage (and not the min coverage). But because of the missing shift, this value is in fact the pool size again, from the call to the inner function mentioned above. Unless we are misunderstanding perl function call rules (which might well be the case), there seems to be something really off here. In summary: The function is computed with coverage=poolsize, but with a detour that first also makes it seem that coverage=min coverage by accident.}

\popoolissue{Lastly, we noted that the computation of $\tilde{n}$ generally results in some non-integer value. However, if we understand the equations for alpha* and beta* correctly, they expect integer values. We did some quick test of this, and it seems that some low non-integer values of pool sizes and coverages can even lead to negative results then. This should not be an issue in practice, but it still seems that something is not quite right here.}

% ------------------------------------------------------------------------------------------------------
\subsubsection*{Final estimator for D}
% ------------------------------------------------------------------------------------------------------

Now that we have a way of computing a reasonable value for the number of individuals sequenced,
we can finally define the estimator:
%
\begin{align}
    \tilde{D}_\text{pool} &:=
    \frac{
        \widehat{\theta}_{\pi, \text{pool}} - \widehat{\theta}_{w, \text{pool}}
            }{
        \sqrt{ {|W|}^{-1} \cdot \alpha^*(\tilde{n}) \widehat{\theta}_{w, \text{pool}} ~+~ \beta^*(\tilde{n}) \widehat{\theta}_{w, \text{pool}}^2 }
    }
\end{align}
%
% \todo{theta b pool W?!}
following PoPoolation and \citeay{Achaz2008}.
This requires $b=2$; furthermore, PoPoolation suggests using ``not too small'' windows.
We are using the size $|W|$ of the window here, that is, the total length along the window in bases, which is typically much larger than the number of SNPs in the window. 

\todo{UNRESOLVED ISSUE: That is what i get from their code. Is that the correct term to use here? should it be the number of SNPs in the window instead?  JPS: I have no idea.  I would need to go through the Achaz paper in some detail to figure it out.}

The above is the estimator as implemented in \toolname{PoPoolation} and in our implementation.

% https://math.stackexchange.com/questions/72223/finding-expected-number-of-distinct-values-selected-from-a-set-of-integers

% \begin{align}
% &\sum_d\sum_k(-1)^{d-k}d\binom{n}{d}\binom{d}{k}\left(\frac{k}{n}\right)^p\\
% &=\sum_d\sum_k(-1)^{d-k}d\binom{n}{k}\binom{n-k}{n-d}\left(\frac{k}{n}\right)^p\\
% &=n-\sum_d\sum_k(-1)^{d-k}(n-d)\binom{n}{k}\binom{n-k}{n-d}\left(\frac{k}{n}\right)^p\\
% &=n-\sum_d\sum_k(-1)^{d-k}(n-k)\binom{n}{k}\binom{n-k-1}{n-d-1}\left(\frac{k}{n}\right)^p\\
% &=n-\sum_k(n-k)\binom{n}{k}\delta(n-k-1)\left(\frac{k}{n}\right)^p\\
% &=n-n\left(\frac{n-1}{n}\right)^p\\
% &=n\left(1-\left(\frac{n-1}{n}\right)^p\right)\tag{2}
% \end{align}

% ------------------------------------------------------------------------------------------------------
%          Assumptions and Biases
% ------------------------------------------------------------------------------------------------------

\subsection{Assumptions and Biases}
\label{supp:sec:TajimaD:sub:AssumptionsBiases}

In the above computation of the correction term for Tajima's D for pool sequencing,
several assumptions were made that lead to the resulting estimator being conservative,
\ie yielding smaller values that what would be expected from individual sequencing of samples.
Based on the explanation in the PoPoolation equations document (most of the text in this section is copied from there),
we explore the underlying assumptions and biases.

The locally fluctuating coverage is replaced by the minimum coverage.
This makes the variance estimator larger, and therefore leads to conservative estimates of Tajima's D.

The random number of different individuals sequenced under a given coverage $C$
is replaced by its expected value $\tilde{n}$.
This assumption should not affect the results much:
If the pool size is large compared to the coverage, sequencing the same individual more than once is uncommon.

Furthermore the number of different individuals sequenced will have a low variance.
As we are working with the minimum coverage, $\tilde{n}$ will be biased downwards,
tending to give a conservative estimate of the variance.

At different positions, the subsets from the pool that are sequenced might be different.
Their coalescent histories will be correlated but not identical.
As the classical equations for Tajima's D are for single samples sharing a common coalescent history,
there is less correlation in the data than assumed with the classical formula.
This again should make the variance approximation more conservative.

Summing up, the approximate variance in the above equations provides a conservative approximation,
and the values for Tajima's D will tend to be smaller than those that would be expected
for an experiment based on individual sequencing of single samples.

Lastly, the PoPoolation code repository contains a plot showing the correlation between the classical Tajima's D
and the corrected Tajima's D using the equations described above;
please see \href{https://github.com/lczech/popoolation/raw/master/files/correlation_classic_correctedTajimasD.png}{here},
where the x-axis corresponds to the classical value, and the y-axis the the corrected one.
This plot has been made with real-world data from Drosophila with a coverage of 12,
a window size of 500 and a minimum count of 1.

% % ------------------------------------------------------------------------------------------------------
% %          Simplified Tajima's D
% % ------------------------------------------------------------------------------------------------------

% \subsection{Simplified Tajima's D}
% \label{supp:sec:TajimaD:sub:Simplified}

% \todo{not sure what this is needed for at the moment...}

% ------------------------------------------------------------------------------------------------------
%          PoPoolation Bugs in Tajima's D
% ------------------------------------------------------------------------------------------------------

\subsection{PoPoolation Bugs}
\label{supp:sec:TajimaD:sub:Bugs}

From our assessment of the \toolname{PoPoolation} code, and from personal communication with Robert Kofler, we found that the implementation of the above $\tilde{D}_\text{pool}$ in \toolname{PoPoolation} $\leq$ v1.2.2 contains several bugs, which alter the numerical results of the computation of Tajima's D.
% At the moment, we are in contact with Robert Kofler, are still verifying these bugs, and are investigating their consequences.
We want to thank Robert for his support regarding our questions.
As a consequence of these bugs, we recommend to only use later versions of \toolname{PoPoolation}, or to use our \toolname{grenedalf} instead, which also offers several additional options and is faster.

\popoolissue{These are the two bugs that we were already in contact with. We already have stated them in the parts of this document where they come up. We just kept this section here for reference, as it is in our preprint.}

% In the implementation of the above $\tilde{D}_\text{pool}$,
% there are two bugs in \toolname{PoPoolation} $\leq$ v1.2.2, which alter the numerical results of the computation of Tajima's D.
% Firstly, they compute $\tilde{n}$ not by using the pool size $n$ and the coverage $C$ as stated above,
% but instead by using the pool size $n$ for both arguments, that is, mistakenly use $C := n$.
% Secondly, instead of computing $\alpha^*$ and $\beta^*$, they only compute $\beta^*$,
% and use this as the value for $\alpha^*$ as well.
% We have examined the effect of these bugs, and present results of the numerical changes induced by them
% in \todo{Supplementary document X}.

% \todo{maybe need to explain the two additional bugs here as well that i mentioned above}

%  \todo{@Lucas. Is it necessary to present plots of this? I think we can say this accounts of x percentage of error with coverage or number of individuals below x number}.

% ======================================================================================================
%          F_ST
% ======================================================================================================

\section{Fixation Index \texorpdfstring{\fst}{FST} for Pool-Seq}
\label{supp:sec:FST}

In this section, we will derive unbiased estimators of various measures of heterozygosity in two populations for Pool-sequencing data.
These will then be combined to obtain ``sample-size'' and ``pool-size'' corrected estimators of two definitions of \fst.
On top of these two novel estimators for \fst{} in the pool-sequencing context, we also walk through the two existing estimators as suggested by \citeay{Kofler2011b} and \citeay{Karlsson2007}.
Both are implemented in \toolname{PoPoolation2}, and are called the ``classical'' or ``conventional pool sequencing'' approach, and the ``Karlsson approach adapted to digital data'', respectively, in \citeay{Kofler2011b}.
We compare all four approaches to each other, and show that the ``classical'' approach is biased for lower coverages or small pool sizes, and the Karlsson approach is biased for small pool sizes (bias on the order of 1/pool size).
See also \citeay{Hivert2018} for an assessment of \fst{} in the pool-sequencing context.

% ------------------------------------------------------------------------------------------------------
%          Definition of F_ST
% ------------------------------------------------------------------------------------------------------

% \subsection{What the actual \texorpdfstring{F\textsubscript{(ST)}}{F(ST)}?}
\label{supp:sec:FST:sub:Definition}

There are several non-equivalent \emph{definitions} of $\text{F}_\text{ST}$.
The overall goal is to measure some degree of differentiation between two populations, which can be represented as a proportion of variation that cannot be explained by variation within populations.
What is unclear is a proportion of \emph{what} variation?
There are two natural candidates leading to two related, but distinct definitions of $\text{F}_\text{ST}$.
The first definition, which we will call $\text{F}_\text{ST}^\text{Nei}$ following \citeay{Nei1973}, considers the proportion of the total variation in the two populations.
This statistic is also called $\text{G}_\text{ST}$, see for example Equation (5.5) of \citeay{Hahn2018}.
The second definition, which we will call $\text{F}_\text{ST}^\text{Hudson}$ following \citeay{Hudson1992}, considers the proportion of the variation between populations, see also \citeay{Cockerham1969} and \citeay{Weir2002}.
This second definition is also considered in \citeay{Karlsson2007}, which we examine below in \secref{supp:sec:FST:sub:Karlsson}.

To make this more formal, we can consider the probability that two haploids carry different alleles.
We could consider drawing the two haploids from the same population (with the population chosen at random), which we call $\pi_\text{within}$; or we could consider drawing the two haploids from \emph{different} populations, which we call $\pi_\text{between}$; or finally we could consider drawing the two haploids totally at random from either population (potentially the same populations, potentially different populations) which we call $\pi_\text{total}$.
See \citeay{Bhatia2013} for more background information on this.

Our two definitions of $\text{F}_\text{ST}$ are then

\begin{align}
    \text{F}_\text{ST}^\text{Nei}    &:= 1 - \frac{\pi_\text{within}}{\pi_\text{total}} \label{eq:popnei}\\
    \text{F}_\text{ST}^\text{Hudson} &:= 1 - \frac{\pi_\text{within}}{\pi_\text{between}} \label{eq:pophudson}
\end{align}

If we consider a single locus with up $4$ alleles, with frequencies $f_{\tau(p)}$ (possibly zero) with  $\tau$ denoting the allele with $\tau \in \left\{A, C, G, T\right\}$ and $p$ denoting the population with subscripts $1$ and $2$, we can calculate the various $\pi$s as follows

\begin{align}
    \label{eq:PiDefs:PiWithin}
    \pi_\text{within} &= \frac{1}{2}\left[\left(1 - \sum_\tau f_{\tau(1)}^2\right) + \left(1 - \sum_\tau f_{\tau(2)}^2\right)\right] \\
    \label{eq:PiDefs:PiBetween}
    \pi_\text{between} &= 1 - \sum_\tau f_{\tau(1)}f_{\tau(2)} \\
    \label{eq:PiDefs:PiTotal}
    \pi_\text{total} &= \frac{1}{2}\pi_\text{within} + \frac{1}{2}\pi_\text{between}
\end{align}

which are then used in our above definitions of \fst.

% ------------------------------------------------------------------------------------------------------
%          Unbiased estimators of the Pi's
% ------------------------------------------------------------------------------------------------------

\subsection{Unbiased estimators of the \texorpdfstring{$\pi$s}{pi's}}
\label{supp:sec:FST:sub:EstimatorsPi}

Since both definitions of $\text{F}_\text{ST}$ rely on these $\pi$s, we will need to derive unbiased estimates for them.
We will show below that the following are unbiased estimators of the corresponding quantities without hats:

\begin{align}
    % \widehat{\pi}_\text{within} &=
    %     \frac{1}{2}
    %     \left[
    %           \left( \frac{n_{(1)}}{n_{(1)}-1} \right) \left( \frac{C_{(1)}}{C_{(1)}-1} \right) \left( 1 - \sum_{\tau} \left( \frac{c_{\tau(1)}}{C_{(1)}} \right)^2 \right)
    %         + \left( \frac{n_{(2)}}{n_{(2)}-1} \right) \left( \frac{C_{(2)}}{C_{(2)}-1} \right) \left( 1 - \sum_{\tau} \left( \frac{c_{\tau(2)}}{C_{(2)}} \right)^2 \right)
    %     \right] \\
    \nonumber
    % Some trickery is needed below for a nice alignment. Not quite perfect, but good enough for now.
    \widehat{\pi}_\text{within} &:=
        \frac{1}{2}
        \Bigg[                                 \left( \frac{n_{(1)}}{n_{(1)}-1} \right) \left( \frac{\coverage_{(1)}}{\coverage_{(1)}-1} \right) \left( 1 - \sum_{\tau} \empfreq_{\tau(1)}^2 \right) \Bigg. \\
        \Bigg. &+ \phantom{\frac{1}{2} \Bigg[} \left( \frac{n_{(2)}}{n_{(2)}-1} \right) \left( \frac{\coverage_{(2)}}{\coverage_{(2)}-1} \right) \left( 1 - \sum_{\tau} \empfreq_{\tau(2)}^2 \right) \Bigg] \\
    \widehat{\pi}_\text{between} &:=
        1 - \sum_{\tau} \empfreq_{\tau(1)}\empfreq_{\tau(2)} \\
    \widehat{\pi}_\text{total} &:=
        \frac{1}{2}\widehat{\pi}_\text{within} + \frac{1}{2}\widehat{\pi}_\text{between}
\end{align}

In the following, we derive these estimators.

% --------------------------------------------------------
%          Pi Within
% --------------------------------------------------------

\subsubsection*{Unbiased estimator of \texorpdfstring{$\widehat{\pi}_\text{within}$}{Pi Within}}
\label{supp:sec:FST:sub:EstimatorsPi:sub:PiWithin}

We have derived previously that
\[
\mathbb{E}\left[\left(\frac{n_{(1)}}{n_{(1)}-1}\right)\left(\frac{\coverage_{(1)}}{\coverage_{(1)}-1}\right)\left(1 - \sum_{\tau}\empfreq_{\tau(1)}^2\right) \right] = \left(1 - \sum_\tau f_{\tau(1)}^2\right)
\]
within a single population.  It follows immediately that averaging these estimators across the two populations is unbiased for $\pi_\text{within}$.

% --------------------------------------------------------
%          Pi Between
% --------------------------------------------------------

\subsubsection*{Unbiased estimator of \texorpdfstring{$\widehat{\pi}_\text{between}$}{Pi Between}}
\label{supp:sec:FST:sub:EstimatorsPi:sub:PiBetween}

Since the two pools are independent, we have that
\[
\mathbb{E}\left[\widehat{\pi}_\text{between}\right] = 1- \sum_\tau \mathbb{E}\left[\empfreq_{\tau(1)}\right]\mathbb{E}\left[\empfreq_{\tau(2)}\right]
\]
The frequency of alleles within a pool is an unbiased estimate for the frequency in the population, so
\[
\mathbb{E}\left[\empfreq_{\tau(p)}\right] = f_{\tau(p)}
\]
showing that $\widehat{\pi}_\text{between}$ is unbiased for $\pi_\text{between}$.

% --------------------------------------------------------
%          Pi Total
% --------------------------------------------------------

\subsubsection*{Unbiased estimator of \texorpdfstring{$\widehat{\pi}_\text{total}$}{Pi Total}}
\label{supp:sec:FST:sub:EstimatorsPi:sub:PiTotal}

That $\widehat{\pi}_\text{total}$ is unbiased for $\pi_\text{total}$ follows immediately from the definition of $\pi_\text{total}$ in \eqnref{eq:PiDefs:PiTotal} and the unbiasedness of $\widehat{\pi}_\text{within}$ and $\widehat{\pi}_\text{between}$.

% ------------------------------------------------------------------------------------------------------
%          Estimating FST
% ------------------------------------------------------------------------------------------------------

\subsection{Final asymptotically unbiased estimators of \texorpdfstring{$\text{F}_\text{ST}$}{FST} per SNP and per window}
\label{supp:sec:FST:sub:EstimatorFST}

These estimators then immediately suggest the following ratio estimators for the different definitions of $\text{F}_\text{ST}$:

\begin{align}
    \widehat{\text{F}}_\text{ST}^\text{Nei} &:= 1 - \frac{\widehat{\pi}_\text{within}}{\widehat{\pi}_\text{total}}\\
    \widehat{\text{F}}_\text{ST}^\text{Hudson} &:= 1 - \frac{\widehat{\pi}_\text{within}}{\widehat{\pi}_\text{between}}
\end{align}

All of this has been for a single site, but we are often interested in combining information across SNPs within a window $W$ (or possibly genome wide).
In such a case, define $\widehat{\pi}^\ell_\text{within}$ to be $\widehat{\pi}_\text{within}$ as above but for SNP $\ell \in W$.
Define $\widehat{\pi}^\ell_\text{between}$ and $\widehat{\pi}^\ell_\text{total}$ analogously.
We then combine information across the SNPs in the window $W$ as

\begin{align}
    \widehat{\text{F}}_\text{ST}^\text{Nei}    &= 1 - \frac{\sum_{\ell \in W} \widehat{\pi}^\ell_\text{within}} {\sum_{\ell \in W} \widehat{\pi}^\ell_\text{total}} \\
    \widehat{\text{F}}_\text{ST}^\text{Hudson} &= 1 - \frac{\sum_{\ell \in W} \widehat{\pi}^\ell_\text{within}} {\sum_{\ell \in W} \widehat{\pi}^\ell_\text{between}}
\end{align}

See \citeay{Bhatia2013} for a practical and theoretical justification for using this ``ratio of averages'' instead of using an ``average of ratios''.
These are our asymptotically unbiased estimators for \fst{} for Pool-seq data, which take the finite sampling of individuals from the population, and the finite sampling of reads from each individual in the pool, into account.

% ------------------------------------------------------------------------------------------------------
%          PoPoolation2 Estimator of FST
% ------------------------------------------------------------------------------------------------------

\subsection{Estimator of \texorpdfstring{$\text{F}_\text{ST}$}{FST} as implemented in PoPoolation2}
\label{supp:sec:FST:sub:PoPoolation2Estimator}

The implementation in \toolname{PoPoolation2} \cite{Kofler2011b} offers two ways to estimate \fst{}:
What they call the ``classical'' or ``conventional'' approach by \citeay{Hartl2007}, and an approach adapted to digital data following \citeay{Karlsson2007}.
In this and the next section, we discuss these estimators.
We later show that they are biased, and hence recommend to use our novel estimates as introduced above instead.
For comparability and historical backwards compatibility, we however still offer both these estimators in our implementation in \toolname{grenedalf}.

% \todo{see if we actually get to do this in time:}
% Furthermore, the PoPoolation equations document explains derivations of equations for Pool-seq corrected estimators of \fst, which however to the best of our knowledge are not actually implemented in either \toolname{PoPoolation} nor \toolname{PoPoolation2}.
% We here still walk through these, see \secref{supp:sec:PoPoolation2Equations}.

First, we present the ``classical'' approach as implemented in \toolname{PoPoolation2}, labelled with superscript ``Kofler'' here, following \citeay{Kofler2011b}.
We compute \fst{} for two subpopulations, which we here again denote with subscripts $(1)$ and $(2)$, and the total population with $(T)$. We expect poolsizes $n >= 2$.

For each SNP in a given window, \toolname{PoPoolation2} computes:
% \verb|f_st_conventional_pool_pi_snp|

\begin{align}
    \label{eq:PoPoolation2FstPi:1}
    \widehat{\pi}_{(1)}^\text{Kofler}  &:= \frac{\coverage_{(1)}}{\coverage_{(1)}-1} \cdot  \left( 1 - \sum_\tau \empfreq_{\tau(1)}^2 \right) \\
    \label{eq:PoPoolation2FstPi:2}
    \widehat{\pi}_{(2)}^\text{Kofler}  &:= \frac{\coverage_{(2)}}{\coverage_{(2)}-1} \cdot  \left( 1 - \sum_\tau \empfreq_{\tau(2)}^2 \right) \\
    \label{eq:PoPoolation2FstPi:T}
    \widehat{\pi}_{(T)}^\text{Kofler}  &:= \frac{\coverage_{(T)}}{\coverage_{(T)}-1} \cdot  \left( 1 - \sum_\tau \empfreq_{\tau(T)}^2 \right) \\
    \nonumber
    \mbox{with} \\
    \nonumber
    \coverage_{(T)} &:= \mbox{min} \left( \coverage_{(1)}, \coverage_{(2)} \right) \\
    \nonumber
    \empfreq_{\tau(T)} &:= \frac{1}{2} \left( \empfreq_{\tau(1)} + \empfreq_{\tau(2)} \right)
\end{align}

These quantities are accumulated over the window $W$, with $(\ell)$ denoting the above at SNP $\ell$
% \verb|f_st_conventional_pool|

\begin{align}
    \label{eq:PoPoolation2FstWindow:1}
    \widehat{\pi}_{W(1)}^\text{Kofler} &= \frac{n_{(1)}}{n_{(1)}-1} \cdot \sum_{\ell\in W} \widehat{\pi}_{(1)}^\text{Kofler}(\ell)\\
    \label{eq:PoPoolation2FstWindow:2}
    \widehat{\pi}_{W(2)}^\text{Kofler} &= \frac{n_{(2)}}{n_{(2)}-1} \cdot \sum_{\ell\in W} \widehat{\pi}_{(2)}^\text{Kofler}(\ell)\\
    \label{eq:PoPoolation2FstWindow:T}
    \widehat{\pi}_{W(T)}^\text{Kofler} &= \frac{n_{(T)}}{n_{(T)}-1} \cdot \sum_{\ell\in W}  \widehat{\pi}_{(T)}^\text{Kofler}(\ell)\\
    \nonumber
    \mbox{with} \\
    \nonumber
    n_{(T)} &= \mbox{min} \left( n_{(1)}, n_{(2)} \right)
\end{align}

Finally, the estimate of \fst is computed as:

\begin{align}
    \label{eq:PoPoolation2FstEst}
    \widehat{\text{F}}_\text{ST}^\text{Kofler} &= \frac{ \widehat{\pi}_{W(T)}^\text{Kofler} - \frac{1}{2} \left(     \widehat{\pi}_{W(1)}^\text{Kofler} +     \widehat{\pi}_{W(2)}^\text{Kofler}  \right)}{ \widehat{\pi}_{W(T)}^\text{Kofler}}
\end{align}

Note that following the notation of the previous section, $\frac{1}{2}\left(\widehat{\pi}_{W(1)}^\text{Kofler} + \widehat{\pi}_{W(2)}^\text{Kofler}\right)$ is identical to the windowed version of $\widehat{\pi}_\text{within}$ and hence is unbiased.  Unfortunately, $\widehat{\pi}_{W(T)}^\text{Kofler}$ however is not an unbiased estimator of $\pi_\text{within}$.  There are a two main issues.  First, recall that $\pi_\text{total} = \frac{1}{2}\left(\pi_\text{between}  + \pi_\text{within} \right)$.  The naive estimator of $\pi_\text{between}$ turns out to be unbiased as shown in the previous section, but yet in the PoPoolation estimator, there is a Bessel correction acting on the whole estimator -- this effectively biases the contribution of the part estimating $\pi_\text{between}$ upward.  Second, $\pi_\text{within}$ has two components corresponding to the two populations.  Since these have different coverages and different sample sizes, the components estimating each of these have different biases that need to be corrected separately.  Instead, PoPoolation uses the minimum coverage and the minimum sample size for both.  This again will result in an upward bias for the sample with higher coverage and/or larger pool size.  Overall, these two errors can result in substantial upward bias for $\widehat{\pi}_{W(T)}^\text{Kofler}$, which will result in substantial upward bias for $\widehat{\text{F}}_\text{ST}^\text{Kofler}$, as we show later.  This was also pointed out by \citeay{Hivert2018}. It is therefore recommended to use the estimator presented in the previous section instead.

% Moi's rendering of the equations. Keeping it here for reference, in case it's later needed.

% We create an unbiased estimator based on $\text{F}_\text{ST}$'s definition based on nucleotide diversity within a sub-population $S$ and across a total set of populations $T$ (see Equation (5.5) of \citeay{Hahn2018}):
% \begin{align}
%     \text{F}_\text{ST} &= \frac{\theta_{\pi,T} - \theta_{\pi,S}}{\theta_{\pi,T}}
% \end{align}
% Since we have already derived unbiased estimators for $\theta_\pi$, given two libraries of DNA sequences from two Pool-seq populations with their corresponding $u$ alternative alleles, $v$ reference alleles, $C$ coverages, and $n$ individuals, we can calculate:
% \begin{align}
%   \text{F}_\text{ST} &=
%     \frac{
%         \theta_\pi(u_1+u_2,v_1+v_2,C_1+C_2,n_1+n_2) -
%         \frac{1}{2}(
%             \theta_\pi(u_1,v_1,C_1,n_1) +
%             \theta_\pi(u_2,v_2,C_2,n_2)
%         )
%     }{
%      \theta_\pi(u_1+u_2,v_1+v_2,C_1+C_2,n_1+n_2)
%     }
% \end{align}

% ------------------------------------------------------------------------------------------------------
%          FST Asymptotically Unbiased, Karlsson
% ------------------------------------------------------------------------------------------------------

\subsection{Asymptotically Unbiased Estimator of \texorpdfstring{\fst}{FST} by Karlsson \textit{et al.}}
\label{supp:sec:FST:sub:Karlsson}

Another estimator for \fst{} that is offered in \toolname{PoPoolation2} is based on the equations used in \citeay{Karlsson2007}, see the last page of the Supplemental Information of Karlsson \textit{et al.} for their derivation.
We here briefly also go through the derivation.
% We also offer this estimator in our implementation, and briefly derive it here.

We here call this estimator using the superscript ``Karlsson'', which is again defined for two subpopulations denoted with subscripts $(1)$ and $(2)$.
% We expect poolsizes $n >= 2$.
We are here only looking at biallelic SNPs.
Instead of $\tau$ for the four nucleotides, we hence use $u$ for the frequency of the major allele and $v$ for the frequency of the minor allele.  We will also use $\widehat{u}$ and $\widehat{v}$ as the corresponding empirical estimates of $u$ and $v$ (\ie the number of reads supporting the major or minor allele divided by the coverage).

We start with the definition of $\text{F}_\text{ST}^\text{Karlsson}$ from Karlsson \textit{et al.} for the SNPs in a window $W$:

\begin{align}
    \label{eq:FstK}
    \text{F}_\text{ST}^\text{Karlsson} &= \frac{\sum_W N_k}{\sum_W D_k}
\end{align}

where the the numerator $N_k$ and denominator $D_k$ for a single site $k$ in $W$ are:

\begin{align}
    \label{eq:FstNk}
    N_k &= v_{(1)} \cdot ( u_{(2)} - u_{(1)} ) ~+~ v_{(2)} \cdot ( u_{(1)} - u_{(2)} ) \\
    \label{eq:FstDk}
    \nonumber
    D_k &= v_{(1)} u_{(2)} + u_{(1)} v_{(2)} \\
        &= N_k + v_{(1)} u_{(1)} + v_{(2)} + u_{(2)}.
\end{align}

It is not obvious, but follows from simple algebra that this definition is equivalent to $ \text{F}_\text{ST}^\text{Hudson} $ defined above.

These are estimated as follows, using the numerator $\hat{N}_k$ and denominator $\hat{D}_k$ at a single site:

\begin{align}
    \label{eq:FstKnh}
    \widehat{N}_k &= \left( \widehat{u}_{(1)} - \widehat{u}_{(2)} \right)^2 - \left( \frac{h_{(1)}}{\coverage_{(1)}} + \frac{h_{(2)}}{\coverage_{(2)}} \right) \\
    \label{eq:FstKdh}
    \widehat{D}_k &= \widehat{N}_k + h_{(1)} + h_{(2)}
    \intertext{with two additional helpers:}
    \nonumber
    h_{(1)} &= \frac{\coverage_{(1)}}{(\coverage_{(1)}-1)}\widehat{u}_{(1)}\widehat{v}_{(1)} \\
    \nonumber
    h_{(2)} &= \frac{\coverage_{(2)}}{(\coverage_{(2)}-1}\widehat{u}_{(2)} \widehat{v}_{(2)}
    \end{align}

And finally, these are used to define estimator $\widehat{\text{F}}_\text{ST}^\text{Karlsson}$ for a window $W$:

\begin{align}
    \label{eq:FstEstK}
    \widehat{\text{F}}_\text{ST}^\text{Karlsson} &= \frac{\sum_W \widehat{N}_k}{\sum_W \widehat{D}_k}
\end{align}

According to Karlsson \textit{et al.}, when the coverages $\coverage_{(1)}$ and $\coverage_{(2)}$ (called ``sample sizes'' there) are equal, the estimator reduces to the estimator of \fst{} given by \citeay{Weir2002}.
Karlsson \textit{et al.} further state that by the Lehmann-Scheff\'{e} theorem \cite[Theorem 4.2.2]{Bickel1977}, it follows that $\widehat{N}_k$ and $\widehat{D}_k$ are uniformly minimum variance unbiased estimators of $N_k$ and $D_k$, respectively, and hence conclude that their estimator \^{F}\textsubscript{ST,K} is also asymptotically unbiased.

This estimator is very similar (after some algebra) to our $\widehat{\text{F}}_\text{ST}^\text{Hudson}$.
It however assumes the pool size to be infinite, that is, it is missing the various corrections for pool size.

% ------------------------------------------------------------------------------------------------------
%          Comparison of the Estimators and their Biases
% ------------------------------------------------------------------------------------------------------

\subsection{Comparison of the Estimators and their Biases}
\label{supp:sec:FST:sub:Comparison}

As mentioned above, both the Kofler estimator in \toolname{PoPoolation2} and the Karlsson estimator have biases.
We here explore their effects via simulations, and further show that our estimators are approximately unbiased under the Pool-seq assumptions so long as sequencing error rates are low.

% --------------------------------------
%     Simulation Setup
% --------------------------------------

\subsubsection*{Simulation Setup}
\label{supp:sec:FST:sub:Comparison:sub:Simulations}

To test the accuracy of the different estimators of $\text{F}_\text{ST}$ we performed two sets of simulations.  In both sets of simulations we assumed a biallelic mutation model, and a simple model of sequencing.  Our sequencing model assumes that (1)~each position is independent, (2)~the number of reads at a given position is Poisson distributed with the mean of that distribution being the ``Read Depth'' of that simulation, (3)~each read is equally likely to come from any individual in the pool, and (4)~with probability ``Seq Error'' a read shows the opposite allele as the individual it was sampled from, but otherwise matches the individual's allele, and this error process is independent across reads.  Across both sets of simulations, we vary the sequencing error in $\left\{0, 10^{-5}, 10^{-4}, 10^{-3}\right\}$, the number of haploid individuals in the pool in $\left\{10, 100, 1000\right\}$, and the mean sequencing depth in $\left\{10, 100, 1000\right\}$.  In both sets of simulations, we obtain population-level allele frequencies at each site, and then compute the true values of either $\neifst$ or $\hudsonfst$ using \cref{eq:popnei,eq:pophudson,eq:PiDefs:PiWithin,eq:PiDefs:PiTotal,eq:PiDefs:PiBetween}.
We here use ``0'' and ``1'' to denote the major and minor allele, respectively.

In the first set of simulations, which we call the ``simple'' simulations, we simulate 1000 sites in two populations.  Let $f_j^{(p)}$ be the frequency of one of the ``1'' allele at position $j$ in population $p$.  To obtain correlated allele frequencies in the two populations we simulated the frequencies as
\begin{align*}
f_j^{(1)} &\overset{i.i.d.}{\sim} \text{Beta}(0.1, 0.5) \\
f_j^{(2)} | f_j^{(1)} &\sim \text{Beta}\left(\frac{\gamma f^{(1)}_j}{1-f^{(1)}_j+10^{-10}}, \gamma\right),
\end{align*}
where $\gamma$ controls the degree of correlation between the frequencies in the two populations.  As $\gamma$ increases, the correlation between the frequencies decreases.  This parameterization is chosen so that $\mathbb{E}\left[f_j^{(2)} \mid f_j^{(1)}\right] = f_j^{(1)}$ up to the error introduced by the $10^{-10}$ which is included for numerical stability.  Then, to obtain the frequency of the ``1'' allele in our pool, we performed independent binomial sampling at each site for each population.  Finally, we obtained the number of reads with the ``0'' and ``1'' alleles as described above.  We varied $\gamma$ in $\left\{0.1, 0.325, 0.55, 0.775, 1\right\}$, and performed 10 simulations each for each setting of $\gamma$, sequencing error, pool size, and sequencing depth, resulting in 1800 simulations.

In the second set of simulations we used \texttt{msprime} \citep{baumdicker2022efficient,kelleher2016efficient} to simulate data under a population genetic model.  In this model, we simulate two populations of constant size that diverged at a time, $t_\text{div}$, in the past, with the ancestral population having the same, constant size.  Across simulations, we varied $t_\text{div}$ in $\left\{0, 0.25, 0.5, 0.75, 1.0\right\}$.  We used a population-scaled mutation rate, $\theta$, of $0.001$, a population-scaled recombination rate, $\rho$, of $0.0001$, and simulated sequences of length $1$ Mb.  Since \texttt{msprime} is a coalescent simulator, it samples individual-level data.  As such, for a given simulation we directly obtain the alleles of the individuals at each of the $10^6$ sites for the individuals that make up our pool sequencing sample.  We then draw reads for each of those sites as described above.  To obtain population-level allele frequencies we simulate an additional 1000 haploid individuals in each population beyond those that make up the pool, and we use the empirical frequencies of the alleles in this 1000 $+$ pool size sample as the ``true'' allele frequencies in each population.

% --------------------------------------
%     valuation and Results
% --------------------------------------

\subsubsection*{Evaluation and Results}
\label{supp:sec:FST:sub:Comparison:sub:Results}

\begin{figure*}[p]
    \centering
    \includegraphics[width=.75\linewidth]{true_hudson_fst-est_spence_hudson-pool_size.pdf}
    \includegraphics[width=.75\linewidth]{true_hudson_fst-est_spence_hudson-seq_error.pdf}
    \includegraphics[width=.75\linewidth]{true_hudson_fst-est_spence_hudson-read_depth.pdf}
    \vspace*{-1em}
    \caption{
%         \textbf{Unbiased Hudson}
        Unbiased Pool-Seq Estimator for FST (Hudson) vs true FST (Hudson).
    }
\label{fig:UnbiasedHudson}
\end{figure*}

\begin{figure*}[p]
    \centering
    \includegraphics[width=.75\linewidth]{true_nei_fst-est_spence_nei-pool_size.pdf}
    \includegraphics[width=.75\linewidth]{true_nei_fst-est_spence_nei-seq_error.pdf}
    \includegraphics[width=.75\linewidth]{true_nei_fst-est_spence_nei-read_depth.pdf}
    \vspace*{-1em}
    \caption{
%         \textbf{Unbiased Nei}
        Unbiased Pool-Seq Estimator for FST (Nei) vs true FST (Nei).
    }
\label{fig:UnbiasedNei}
\end{figure*}

\begin{figure*}[p]
    \centering
    \includegraphics[width=.75\linewidth]{true_nei_fst-est_kofler-pool_size.pdf}
    \includegraphics[width=.75\linewidth]{true_nei_fst-est_kofler-seq_error.pdf}
    \includegraphics[width=.75\linewidth]{true_nei_fst-est_kofler-read_depth.pdf}
    \vspace*{-1em}
    \caption{
%         \textbf{Kofler}
        Kofler Estimator for FST vs true FST (Nei).
    }
\label{fig:Kofler}
\end{figure*}

\begin{figure*}[p]
    \centering
    \includegraphics[width=.75\linewidth]{true_hudson_fst-est_karlsson-pool_size.pdf}
    \includegraphics[width=.75\linewidth]{true_hudson_fst-est_karlsson-seq_error.pdf}
    \includegraphics[width=.75\linewidth]{true_hudson_fst-est_karlsson-read_depth.pdf}
    \vspace*{-1em}
    \caption{
%         \textbf{Karlsson}
        Karlsson Estimator for FST vs true FST (Hudson).
    }
\label{fig:Karlsson}
\end{figure*}

We find that the estimators we derived in Section~\ref{supp:sec:FST:sub:EstimatorFST} are approximately unbiased across all regimes except for the \texttt{msprime} simulations with the highest sequencing error rate, see \figref{fig:UnbiasedHudson} and \figref{fig:UnbiasedNei}.

In contrast, in \figref{fig:Kofler} we find that the Kofler estimator of $\neifst$ is highly biased in a way that depends on pool size and average read depth.  This makes sense because as discussed above, the Kofler estimate of $\pi_\text{between}$ includes a Bessel correction when it should not.  That Bessel correction contains terms that depend on both the pool size and the the read depth, and
\todo{Jeff, there seems to be an end missing for this sentence}

Similarly, in \figref{fig:Karlsson} we find that the Karlsson estimator of $\hudsonfst$ is highly biased for small pool sizes, but otherwise performs well (again except for the case of high sequencing error).  Again, this makes sense as the Karlsson estimator implicitly assumes an infinite pool size, and so will be biased for small pool sizes.

For the \texttt{msprime} simulations with the highest sequencing error rate, we see that all methods severely underestimate \fst.  It makes sense that the methods should be biased as none of the estimators account for sequencing error. In the \texttt{msprime} simulations, most sites are not segregating in the population.  Sites that are not segregating do not contribute to the true value of \fst{} -- they act as a $0$ added to each of the $\pi$'s. Calling the rate of sequencing error~$\epsilon$, all of the above estimators add something $\approx \epsilon$ over the number of sites to each of the $\widehat{\pi}$'s in expectation.  As a result, for $\neiestimator := 1 - \frac{\widehat{\pi}_\text{within}}{\widehat{\pi}_\text{total}}$, for example, we add something on the order of $\epsilon$ to our estimates of $\widehat{\pi}_\text{within}$ and $\widehat{\pi}_\text{total}$.  This inflates $\frac{\widehat{\pi}_\text{within}}{\widehat{\pi}_\text{total}}$ causing us to underestimate $\neifst$.  A similar phenomenon occurs for $\hudsonestimator$, as well as the other estimators.  To see that invariant sites add $\approx\epsilon$ over the total number of sites to any of the $\widehat{\pi}$'s, consider an asymptotic regime where both the read depth and the pool size are large.  In this regime, if there were no sequencer error, the empirical frequency of each allele across reads is a very accurate estimate of the the true population allele frequency.  In particular, for invariant sites, all of the reads will show the ``0'' allele across both populations.  If we add sequencing error, then approximately $\epsilon$ proportion of the reads will show the ``1'' allele in each population.  Our estimators ignore sequencing error, and so in this case, it would look like both populations have the ``1'' allele at frequency $\epsilon$.  Naively plugging these frequencies into $\pi_\text{within}$, $\pi_\text{between}$, or $\pi_\text{total}$ we obtain $\epsilon(1-\epsilon)\approx \epsilon$.  In practice, at invariant sites, the different estimators would include various Bessel corrections, but the intuition holds, and these sites contribute approximately $\epsilon$ to the overall estimates of the different $\pi$'s.  As a result, if $\epsilon$ is comparable to or larger than any of the $\pi$'s, then any of the \fst estimates will be significantly biased.  Indeed, in the \texttt{msprime} simulations, we would expect $\pi_\text{within}$ to be approximately $\theta$ which is $0.001$, matching the highest sequencing error simulations, and explaining the apparent bias.  In contrast, in the ``simple'' simulations, $\pi_\text{within}$ is approximately $0.03$ which is an order of magnitude larger than the highest sequencing error simulated.

% We hence highly recommend to use our novel estimators over the ones implemented in \toolname{PoPoolation2}.

% ------------------------------------------------------------------------------------------------------
%          PoPoolation2 Equations Document
% ------------------------------------------------------------------------------------------------------
% \todo{(Moi) I think is fine to just say this and not go through equations ;) }

\section{PoPoolation2 Equations Document}
\label{supp:sec:PoPoolation2Equations}

The PoPoolations equation document also presents some simplifications and related equations that to the best of our knowledge are not implemented in their software.
We hence do not go through them in detail here, but still want to mention them, in case they might be useful for others.

\begin{itemize}
  \item They present simplified versions of $\theta_\pi$, $\theta_w$, and Tajima's D, which assume that allele frequency distribution in the reads is about the same as in the real population, and hence arrives at a simpler computation at the cost of some error. These are also useful for individual sequencing.
  \item As mentioned above in \secref{supp:sec:TajimaD:sub:PoolSequencingCorrection}, the document presents an approach to computing Tajima's D based on its variance, and extends this to windows, but (to the best of our knowledge) does not implement this, and instead implement their approach based on \citeay{Achaz2008}.
  \item They present an approach for computing \fst{} for $J$ pool-sequenced populations (instead of just two as presented above), extend this approach to large regions as well as single SNPs, and introduce weights that take the number of sequenced individuals in each population into account. More work is needed to compare this approach to their implementation and to our estimators.
\end{itemize}

These alternative approaches however need further assessment and comparison to the other approaches presented here.

\popoolissue{Lastly, we wanted to note that to us it seems that some equations in the PoPoolation equations document are not actually implemented in the code, and that the code contains compuations that are not in the document. We hence think that those were never intended to go hand in hand, and that hence the equations document is also not part of the official publication, but merely found in the code repository. Is that assessment correct, or are there other reasons for the divergence between the two?}

% The Pool-seq corrected equations for $\text{F}_\text{ST}$ available in the pdf document of PoPoolation's code repository are not implemented, to the best of our knowledge, in \toolname{PoPoolation} nor in \toolname{PoPoolation2} software.
% Here we describe the methods implemented in \toolname{PoPoolation2} code, explain the rationale, and expand on calculation options of our own implementation.
% See \citeay{Bhatia2013} for a good introduction to the topic and the confusion around \fst.

% The below section names are what the PoPoolation equations document offers.
% At the moment however, it seems that the implementation (which is not in \toolname{PoPoolation}, but in \toolname{PoPoolation2})
% differs from the equations that they have in their document.
% So, instead of copying the above equations from their document to here for somthing that is not even implemented,
% as of now, we leave the above blank.

% Instead, we here write down the equations that are actually implemented in \toolname{PoPoolation2}, based on the code.

% % --------------------------------------------------------
% %          Large Regions
% % --------------------------------------------------------

% \subsubsection{Large Regions}
% \label{supp:sec:FST:sub:LargeRegions}

% % --------------------------------------------------------
% %          Simplified
% % --------------------------------------------------------

% \subsubsection{Simplified Regional \texorpdfstring{\fst}{FST}}
% \label{supp:sec:FST:sub:Simplified}

% % (also good for individual sequencing again)

% % --------------------------------------------------------
% %          Single SNPs
% % --------------------------------------------------------

% \subsubsection{Single SNPs}
% \label{supp:sec:FST:sub:SingleSNPs}

% % --------------------------------------------------------
% %          Weights
% % --------------------------------------------------------

% \subsubsection{Weights}
% \label{supp:sec:FST:sub:Weights}

% % ======================================================================================================
% %          SCRATCH
% % ======================================================================================================

% \todo{the below are (commented out) reverse-engineered equations of the non-pool-seq-corrected equations that are also implemented in popoolation. we probably do not need them, but i want to keep them here for reference, if needed.}

% \section{SCRATCH}
% \label{supp:sec:SCRATCH}

% \todo{scratch space added by Lucas to write down PoPoolation equations as implemented}

% \subsection{Classical}
% \label{supp:sec:SCRATCH:sub:Classical}

% these are what popoolation calls ``classical'' computations, that is, without pool seq correction.
% they still use some equations that do not seem 100\% typical to me, but let's see.

% \textbf{classical pi:}

% \begin{align}
%     \theta_{\pi,Classical} &=  1 - \frac{2}{C(C-1)} \sum_\tau \frac{c_\tau (c_\tau - 1)}{2}
% \end{align}

% the call this computation ``average pairwise difference''.
% the 2s obviously cancel out, but i kept them here, as this is what's implemented.


% \textbf{classical theta (watterson): }

% \begin{align}
%     \theta_{W,Classical} &=  \frac{\text{\#SNPs}}{a_1(n_m)}
% \end{align}

% where $n_m$ is the median of all coverages in the given window,
% and $a_1$ again the harmonic as defined above.
% no idea if this is a thing that one does... but that's what they do.


% \textbf{classical D:}

% \begin{align}
%     D &=  \frac{\theta_{\pi,Classical} - \theta_{W,Classical}}{V}
% \end{align}

% where $V$ is called ``sqrt variance'', probably meaning square root of the variance, i.e., standard deviation?! and computed as:

% \begin{align}
%     V   &= \sqrt{ e_1 \cdot \text{\#SNPs} + e_2 \cdot \text{\#SNPs} \cdot (\text{\#SNPs} -1) } \\
%     e_1 &= \frac{ \frac{n_m + 1}{3 \cdot (n_m - 1)} - \frac{1}{a_1(n_m)} }{a_1(n_m)} \\
%     e_2 &= \frac{ \frac{2(n_m^2 + n_m + 3)}{9n_m(n_m-1)} - \frac{n_m+2}{a_1(n_m) \cdot n_m} + \frac{a_2(n_m)}{a_1(n_m)^2} }{ a_1(n_m)^2 + a_2(n_m) }
% \end{align}

% again using the median coverage $n_m$, and (squared) harmonic $a_1$ and $a_2$.


% ======================================================================================================
%          Conclusion
% ======================================================================================================

% \section{Conclusion}
% \label{supp:sec:Conclusion}

% \todo{needs updating later}

% We have here presented our current understanding of the equations and the implementation of PoPoolation \cite{Kofler2011a,Kofler2011b} for population genetic measures $\theta_\pi$, $\theta_w$, Tajima's D, and \fst{}. We have further introduced two novel estimators of \fst{} for pool-sequenced data.

% We invite everyone to join the discussion and to help establishing well-founded theory of these measures for pool sequencing.
% Hence, this document is a draft, and more work is needed to thoroughly assess the whole situation.
% % There might be bugs in the \toolname{PoPoolation} implementation of Tajima's D.


% ######################################################################################################################
%         Appendices
% ######################################################################################################################

% \clearpage

% Bibliography
% \bibliographystyle{pnas-new}
\bibliographystyle{natbib}
% \bibliographystyle{apalike}
% \bibliographystyle{myabbrvnat}

\bibliography{references}

\end{document}
